[{"filePath":"/Users/anonymous/Desktop/realmm/social-map-app/src/pages/MapHome.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'generateRandomRPMAvatar' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":11,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":46,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRandomRPMAvatar"},"fix":{"range":[609,634],"text":""},"desc":"Remove unused variable 'generateRandomRPMAvatar'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'isBlockedMutual' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":12,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":74,"suggestions":[{"messageId":"removeVar","data":{"varName":"isBlockedMutual"},"fix":{"range":[722,739],"text":""},"desc":"Remove unused variable 'isBlockedMutual'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'generateMockUsers' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":50,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":50,"endColumn":24},{"ruleId":"no-unused-vars","severity":2,"message":"'showFilters' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":255,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":255,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"showFilters"},"fix":{"range":[10878,10889],"text":""},"desc":"Remove unused variable 'showFilters'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'setShowFilters' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":255,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":255,"endColumn":39,"suggestions":[{"messageId":"removeVar","data":{"varName":"setShowFilters"},"fix":{"range":[10889,10905],"text":""},"desc":"Remove unused variable 'setShowFilters'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'loading' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":333,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":333,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"loading"},"fix":{"range":[13660,13667],"text":""},"desc":"Remove unused variable 'loading'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":349,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":349,"endColumn":19},{"ruleId":"no-unused-vars","severity":2,"message":"'onboardingImage' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":391,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":391,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"onboardingImage"},"fix":{"range":[16018,16033],"text":""},"desc":"Remove unused variable 'onboardingImage'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'isCameraOpen' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":392,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":392,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"isCameraOpen"},"fix":{"range":[16084,16096],"text":""},"desc":"Remove unused variable 'isCameraOpen'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'currentUser'. Either include it or remove the dependency array.","line":526,"column":8,"nodeType":"ArrayExpression","endLine":526,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [currentUser]","fix":{"range":[22661,22663],"text":"[currentUser]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'safeName' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":771,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":771,"endColumn":39,"suggestions":[{"messageId":"removeVar","data":{"varName":"safeName"},"fix":{"range":[34062,34135],"text":""},"desc":"Remove unused variable 'safeName'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'hasLocation' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":876,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":876,"endColumn":34},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'userLocation'. Either include it or remove the dependency array.","line":1164,"column":8,"nodeType":"ArrayExpression","endLine":1164,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [navigate, userLocation]","fix":{"range":[52002,52012],"text":"[navigate, userLocation]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'handlePermissionSelect' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1168,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1168,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"handlePermissionSelect"},"fix":{"range":[52022,52305],"text":""},"desc":"Remove unused variable 'handlePermissionSelect'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'handleEnableLocation' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1176,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1176,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleEnableLocation"},"fix":{"range":[52312,52561],"text":""},"desc":"Remove unused variable 'handleEnableLocation'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'startCamera' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1190,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1190,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"startCamera"},"fix":{"range":[52685,53111],"text":""},"desc":"Remove unused variable 'startCamera'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'capturePhoto' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1202,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1202,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"capturePhoto"},"fix":{"range":[53117,53745],"text":""},"desc":"Remove unused variable 'capturePhoto'."}]},{"ruleId":"no-undef","severity":2,"message":"'now' is not defined.","line":1364,"column":44,"nodeType":"Identifier","messageId":"undef","endLine":1364,"endColumn":47},{"ruleId":"no-undef","severity":2,"message":"'now' is not defined.","line":1365,"column":37,"nodeType":"Identifier","messageId":"undef","endLine":1365,"endColumn":40},{"ruleId":"no-unused-vars","severity":2,"message":"'calculateDistance' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1379,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1379,"endColumn":28,"suggestions":[{"messageId":"removeVar","data":{"varName":"calculateDistance"},"fix":{"range":[59577,60134],"text":""},"desc":"Remove unused variable 'calculateDistance'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'err' is defined but never used.","line":1535,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":1535,"endColumn":25},{"ruleId":"no-dupe-else-if","severity":2,"message":"This branch can never execute. Its condition is a duplicate or covered by previous conditions in the if-else-if chain.","line":1630,"column":18,"nodeType":"BinaryExpression","messageId":"unexpected","endLine":1630,"endColumn":37},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has missing dependencies: 'createAvatarIcon' and 'userLocation'. Either include them or remove the dependency array.","line":1775,"column":8,"nodeType":"ArrayExpression","endLine":1775,"endColumn":59,"suggestions":[{"desc":"Update the dependencies array to be: [createAvatarIcon, currentUser, userLocation]","fix":{"range":[76051,76102],"text":"[createAvatarIcon, currentUser, userLocation]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has missing dependencies: 'createAvatarIcon', 'userLocation.lat', and 'userLocation.lng'. Either include them or remove the dependency array.","line":1996,"column":8,"nodeType":"ArrayExpression","endLine":1996,"endColumn":36,"suggestions":[{"desc":"Update the dependencies array to be: [filteredUsers, userLocation.lat, userLocation.lng, createAvatarIcon, currentUser]","fix":{"range":[85869,85897],"text":"[filteredUsers, userLocation.lat, userLocation.lng, createAvatarIcon, currentUser]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'ghostMode' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1998,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1998,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"ghostMode"},"fix":{"range":[85905,85959],"text":""},"desc":"Remove unused variable 'ghostMode'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'currentUser'. Either include it or remove the dependency array.","line":2026,"column":8,"nodeType":"ArrayExpression","endLine":2030,"endColumn":6,"suggestions":[{"desc":"Update the dependencies array to be: [locationEnabled, currentUser.is_ghost_mode, currentUser.is_location_on, currentUser]","fix":{"range":[86838,86942],"text":"[locationEnabled, currentUser.is_ghost_mode, currentUser.is_location_on, currentUser]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'lat', 'lng', and 'map'. Either include them or remove the dependency array.","line":176,"column":8,"nodeType":"ArrayExpression","endLine":176,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [lat, lng, map, mapMode]","fix":{"range":[7986,7995],"text":"[lat, lng, map, mapMode]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":21,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MapContainer, TileLayer, Marker, Circle, useMap, LayersControl, LayerGroup } from 'react-leaflet';\nimport L from 'leaflet';\nimport React, { useState, useEffect, useRef, useMemo } from 'react';\nimport { useTheme } from '../context/ThemeContext';\nimport { useNavigate, useLocation } from 'react-router-dom';\nimport { supabase } from '../supabaseClient';\nimport MapProfileCard from '../components/MapProfileCard';\nimport FullProfileModal from '../components/FullProfileModal';\nimport PokeNotifications from '../components/PokeNotifications';\nimport Toast from '../components/Toast';\nimport { getAvatar2D, generateRandomRPMAvatar } from '../utils/avatarUtils';\nimport { getBlockedUserIds, getBlockerIds, isUserBlocked, isBlockedMutual } from '../utils/blockUtils';\nimport { useLocationContext } from '../context/LocationContext';\nimport { useCall } from '../context/CallContext';\nimport LimitedModeScreen from '../components/LimitedModeScreen';\nimport StoryViewer from '../components/StoryViewer';\nimport { uploadToStorage } from '../utils/fileUpload';\nimport { DEFAULT_MALE_AVATAR, DEFAULT_FEMALE_AVATAR, DEFAULT_GENERIC_AVATAR } from '../utils/avatarUtils';\nimport ImageCropper from '../components/ImageCropper';\nimport BottomNav from '../components/BottomNav';\n\n\n// Fix icon issues\ndelete L.Icon.Default.prototype._getIconUrl;\nL.Icon.Default.mergeOptions({\n    iconRetinaUrl: null,\n    iconUrl: null,\n    shadowUrl: null,\n});\n\n// Helper: Distance\nfunction getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {\n    var R = 6371;\n    var dLat = deg2rad(lat2 - lat1);\n    var dLon = deg2rad(lon2 - lon1);\n    var a =\n        Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *\n        Math.sin(dLon / 2) * Math.sin(dLon / 2);\n    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n    var d = R * c;\n    return d;\n}\n\nfunction deg2rad(deg) {\n    return deg * (Math.PI / 180);\n}\n\n// Generate Users with Drift for Animation\nconst generateMockUsers = (centerLat, centerLng) => {\n    const users = [];\n    const MOODS = ['Happy ğŸŒ', 'Chilling â˜•', 'Working ğŸ’»', 'Gym ğŸ’ª', 'Party ğŸ‰'];\n    const STATUSES = ['Available', 'Busy', 'At Work', 'Online'];\n    const RELATIONSHIPS = ['Single ğŸ•º', 'Married ğŸ’', 'Committed ğŸ’–', 'It\\'s Complicated ğŸŒ€'];\n    const THOUGHTS = ['Let\\'s talk ğŸ’¬', 'Coffee? â˜•', 'Anyone here? ğŸ‘‹', 'Gym? ğŸ’ª', 'Food run! ğŸ”'];\n\n    for (let i = 0; i < 20; i++) {\n        // Fuzzing: Random offset within 500m\n        const latOffset = (Math.random() - 0.5) * 0.01;\n        const lngOffset = (Math.random() - 0.5) * 0.01;\n        users.push({\n            id: i,\n            name: `User ${i}`,\n            lat: centerLat + latOffset,\n            lng: centerLng + lngOffset,\n            // Store target for animation (not implemented in this simple mock, but good for structure)\n            targetLat: centerLat + latOffset,\n            targetLng: centerLng + lngOffset,\n            // Use realistic defaults instead of cartoons\n            avatar: i % 2 === 0 ? '/defaults/male_avatar.jpg' : '/defaults/female_avatar.jpg',\n            lastActive: 'Now',\n            isLocationOn: Math.random() > 0.2,\n            mood: MOODS[Math.floor(Math.random() * MOODS.length)],\n            // Randomly assign thoughts to some users (High probability for demo)\n            thought: Math.random() > 0.2 ? THOUGHTS[Math.floor(Math.random() * THOUGHTS.length)] : null,\n            thoughtTime: Date.now() - Math.floor(Math.random() * 3600000), // Within last hour\n            relationshipStatus: RELATIONSHIPS[Math.floor(Math.random() * RELATIONSHIPS.length)],\n            isLocationShared: Math.random() > 0.8 // Only 20% agree to share exact location interactions\n        });\n    }\n    return users;\n};\n\n// Control to manually recenter map\nfunction RecenterControl({ lat, lng }) {\n    const map = useMap();\n\n    const handleRecenter = (e) => {\n        e.stopPropagation();\n        if (lat && lng) {\n            // Zoom level 17 provides a closer view while still showing immediate surroundings\n            map.flyTo([lat, lng], 17, { animate: true, duration: 1.5 });\n        }\n    };\n\n    return (\n        <div \n            className=\"leaflet-bottom leaflet-right\" \n            style={{ \n                bottom: 'calc(80px + env(safe-area-inset-bottom))', /* Shifted up to clear BottomNav + Safe Area */\n                right: '8px',   /* Shifted right again */\n                zIndex: 400,\n                pointerEvents: 'auto',\n                position: 'absolute'\n            }}\n        >\n            <div className=\"leaflet-control\">\n                <button\n                    onClick={handleRecenter}\n                    title=\"Recenter Map\"\n                    style={{\n                        width: '36px',\n                        height: '36px',\n                        backgroundColor: '#4285F4', /* Primary Blue */\n                        border: 'none',\n                        borderRadius: '50%',\n                        boxShadow: '0 4px 12px rgba(66, 133, 244, 0.4)',\n                        cursor: 'pointer',\n                        display: 'flex',\n                        alignItems: 'center',\n                        justifyContent: 'center',\n                        color: 'white', /* White Icon */\n                        transition: 'all 0.2s ease',\n                        padding: 0\n                    }}\n                    onMouseDown={e => { e.stopPropagation(); e.currentTarget.style.transform = 'scale(0.96)'; }}\n                    onMouseUp={e => { e.stopPropagation(); e.currentTarget.style.transform = 'scale(1)'; }}\n                    onMouseEnter={e => { \n                        e.currentTarget.style.boxShadow = '0 6px 16px rgba(66, 133, 244, 0.5)';\n                        e.currentTarget.style.transform = 'scale(1.05)';\n                    }}\n                    onMouseLeave={e => { \n                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(66, 133, 244, 0.4)';\n                        e.currentTarget.style.transform = 'scale(1)';\n                    }}\n                    onDoubleClick={e => e.stopPropagation()}\n                >\n                    {/* Standard Crosshair/Target Icon */}\n                    <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n                        <path d=\"M12 8C9.79 8 8 9.79 8 12C8 14.21 9.79 16 12 16C14.21 16 16 14.21 16 12C16 9.79 14.21 8 12 8ZM12 19C8.13 19 5 15.87 5 12C5 8.13 8.13 5 12 5C15.87 5 19 8.13 19 12C19 15.87 15.87 19 12 19ZM12 3C7.03 3 3 7.03 3 12C3 16.97 7.03 21 12 21C16.97 21 21 16.97 21 12C21 7.03 16.97 3 12 3Z\" fill=\"currentColor\" fillOpacity=\"0.9\"/>\n                        <path d=\"M12 3V1M21 12H23M12 21V23M3 12H1\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\"/>\n                    </svg>\n                </button>\n            </div>\n        </div>\n    );\n}\n\n// Component to handle automatic recentering\nfunction RecenterAutomatically({ lat, lng, mapMode }) {\n    const map = useMap();\n    const hasCentered = useRef(false);\n    const prevMapMode = useRef(mapMode); // Track previous mapMode to detect real changes\n\n    // Initial Center â€” only once, on first valid location\n    useEffect(() => {\n        if (lat && lng && !hasCentered.current) {\n            const zoomLevel = 17;\n            const timer = setTimeout(() => {\n                 map.setView([lat, lng], zoomLevel, { animate: false });\n                 hasCentered.current = true;\n            }, 50);\n            return () => clearTimeout(timer);\n        }\n    }, [lat, lng, map]);\n\n    // Re-center ONLY when map mode actually switches (not on mount)\n    useEffect(() => {\n        if (prevMapMode.current !== mapMode) {\n            prevMapMode.current = mapMode;\n            if (lat && lng) {\n                map.flyTo([lat, lng], map.getZoom(), { animate: true, duration: 1 });\n            }\n        }\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [mapMode]);\n\n    return null;\n}\n\n// Map Controller: Handle User Selection & Zoom (with Mobile Offset)\nfunction UserSelectionController({ selectedUser }) {\n    const map = useMap();\n\n    useEffect(() => {\n        // console.log('ğŸ—ºï¸ [UserSelectionController] selectedUser changed:', selectedUser);\n        \n        if (!selectedUser) {\n            return;\n        }\n\n        // Support both lat/lng and latitude/longitude property names\n        const lat = selectedUser.latitude || selectedUser.lat;\n        const lng = selectedUser.longitude || selectedUser.lng;\n\n        if (!lat || !lng) {\n            console.log('ğŸ—ºï¸ [UserSelectionController] No valid coordinates. lat:', lat, 'lng:', lng);\n            return;\n        }\n\n        const targetLat = parseFloat(lat);\n        const targetLng = parseFloat(lng);\n        const zoomLevel = 18; // Close zoom for profile view\n\n        // Check for Mobile (Approximate check using window width)\n        const isMobile = window.innerWidth <= 768;\n        console.log('ğŸ—ºï¸ [UserSelectionController] isMobile:', isMobile, 'width:', window.innerWidth);\n\n        if (isMobile) {\n            // Calculate Offset used by MapProfileCard (Usually ~45-50vh height)\n            // We want the user marker to be in the Top ~40% of the screen\n            // Standard flyTo centers in middle (50%)\n            // We need to shift the center \"Down\" so the marker appears \"Up\"\n\n            // Convert LatLng to Container Point (Pixels)\n            const point = map.project([targetLat, targetLng], zoomLevel);\n            \n            // Shift Y down by 25% of screen height (to move center down)\n            const yOffset = window.innerHeight * 0.25; \n            const targetPoint = L.point(point.x, point.y + yOffset);\n            \n            // Convert back to LatLng\n            const newCenter = map.unproject(targetPoint, zoomLevel);\n\n            console.log('ğŸ—ºï¸ [UserSelectionController] Flying to (mobile offset):', newCenter, 'zoom:', zoomLevel);\n            \n            // Use setTimeout to ensure map is ready\n            setTimeout(() => {\n                map.setView(newCenter, zoomLevel, {\n                    animate: true,\n                    duration: 1.2\n                });\n            }, 100);\n        } else {\n            // Desktop: Center normally\n            console.log('ğŸ—ºï¸ [UserSelectionController] Flying to (desktop):', [targetLat, targetLng], 'zoom:', zoomLevel);\n            \n            setTimeout(() => {\n                map.setView([targetLat, targetLng], zoomLevel, {\n                    animate: true,\n                    duration: 1.2\n                });\n            }, 100);\n        }\n\n    }, [selectedUser, map]);\n\n    return null;\n}\n\nexport default function MapHome() {\n    // Map UI State\n    const [searchQuery, setSearchQuery] = useState('');\n    const [activeFilter, setActiveFilter] = useState('All');\n    const [showFilters, setShowFilters] = useState(false);\n    const [mapMode, setMapMode] = useState('street'); // 'street', 'hybrid', 'satellite'\n\n    // Theme & Location Context (Moved to top)\n    const { theme } = useTheme();\n    const { \n        userLocation,\n        locationEnabled,\n        loadingLocation,\n        startLocation,\n        stopLocation,\n    } = useLocationContext();\n\n    // Notification State\n    const [friendRequests, setFriendRequests] = useState([]);\n\n    // Fetch Notifications\n    useEffect(() => {\n        const fetchNotifications = async () => {\n            const { data: { session } } = await supabase.auth.getSession();\n            const user = session?.user;\n            if (!user) return;\n\n            // Requests\n            const { count: requestCount } = await supabase\n                .from('friendships')\n                .select('id', { count: 'exact', head: true })\n                .eq('receiver_id', user.id)\n                .eq('status', 'pending');\n            \n            if (requestCount !== null) {\n                // Mock array for length since we only use .length for badge\n                setFriendRequests(new Array(requestCount).fill(0));\n            }\n        };\n\n        fetchNotifications();\n    }, []);\n\n    // Filter Options\n    const FILTERS = ['All', 'Online', 'Nearby', 'Friends'];\n\n    // Call Context\n    const { startCall } = useCall();\n\n    const [viewingStoryUser, setViewingStoryUser] = useState(null);\n\n    // Initialize state synchronously to prevent flash\n    const [isDarkMode, setIsDarkMode] = useState(() => {\n        if (theme === 'dark') return true;\n        if (theme === 'light') return false;\n        if (typeof window !== 'undefined' && window.matchMedia) {\n            return window.matchMedia('(prefers-color-scheme: dark)').matches;\n        }\n        return false;\n    });\n\n    useEffect(() => {\n        const checkDarkMode = () => {\n            if (theme === 'dark') return true;\n            if (theme === 'light') return false;\n            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;\n        };\n        setIsDarkMode(checkDarkMode());\n\n        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');\n        const handleChange = () => {\n            if (theme === 'system') setIsDarkMode(mediaQuery.matches);\n        };\n        mediaQuery.addEventListener('change', handleChange);\n        return () => mediaQuery.removeEventListener('change', handleChange);\n    }, [theme]);\n\n    const friendshipsRef = useRef(new Map()); // Map<friendship_id, partner_id>\n    const blockedIdsRef = useRef(new Set()); // Blocked users cache\n\n    const [nearbyUsers, setNearbyUsers] = useState([]);\n    const [selectedUser, setSelectedUser] = useState(null);\n    const [loading, setLoading] = useState(true);\n    // const [isGhostMode, setGhostMode] = useState(false); // ğŸ”¥ REMOVED local state\n    const navigate = useNavigate();\n    const routeLocation = useLocation();\n\n    // Initialize from LocalStorage + Nav State for Zero Latency\n    const [currentUser, setCurrentUser] = useState(() => {\n        try {\n            const stored = localStorage.getItem('currentUser');\n            let user = stored ? JSON.parse(stored) : null;\n\n            // Instant Override from Login Navigation (Healing)\n            if (routeLocation?.state?.preloadedAvatar && user) {\n                user.avatar_url = routeLocation.state.preloadedAvatar;\n            }\n            return user;\n        } catch (e) {\n            return null;\n        }\n    });\n    const [toastMsg, setToastMsg] = useState(null);\n    const [showReportModal, setShowReportModal] = useState(false);\n    const [reportTarget, setReportTarget] = useState(null);\n    const [showMuteModal, setShowMuteModal] = useState(false);\n    const [muteTarget, setMuteTarget] = useState(null);\n    const [showFullProfile, setShowFullProfile] = useState(false);\n    const [fullProfileUser, setFullProfileUser] = useState(null);\n\n    // Image Preloader for Instant Rendering\n    useEffect(() => {\n        if (!nearbyUsers || nearbyUsers.length === 0) return;\n\n        nearbyUsers.forEach(user => {\n            if (user.avatar) {\n                const img = new Image();\n                img.src = getAvatar2D(user.avatar);\n            }\n        });\n\n        // Also preload current user\n        if (currentUser?.avatar_url) {\n            const img = new Image();\n            img.src = getAvatar2D(currentUser.avatar_url);\n        }\n    }, [nearbyUsers, currentUser?.avatar_url]);\n\n\n    // Floating Thought State\n    const [showThoughtInput, setShowThoughtInput] = useState(false);\n    const [myThought, setMyThought] = useState('');\n\n    // --- Onboarding State ---\n    const [showProfileSetup, setShowProfileSetup] = useState(false);\n    const [setupData, setSetupData] = useState({ gender: '', status: '', relationshipStatus: '', username: '' });\n    // New state for modal upload\n    const [avatarFile, setAvatarFile] = useState(null);\n    const [avatarPreview, setAvatarPreview] = useState(null);\n    const [cropImage, setCropImage] = useState(null); // State for cropping\n    const [onboardingImage, setOnboardingImage] = useState(null);\n    const [isCameraOpen, setIsCameraOpen] = useState(false);\n    const videoRef = React.useRef(null);\n    const canvasRef = React.useRef(null);\n\n    // Check Profile Completeness\n    useEffect(() => {\n        const checkUser = async () => {\n            const { data: { session } } = await supabase.auth.getSession();\n            const user = session?.user;\n            if (!user) return; // handled by other effect\n\n            const { data: profile } = await supabase\n                .from('profiles')\n                .select('*')\n                .eq('id', user.id)\n                .maybeSingle();\n\n            // Bypass if locally flagged as complete (immediate fix for loop)\n            const setupCompleteLocal = localStorage.getItem('setup_complete') === 'true';\n\n            // Safety Net: Trigger modal ONLY if critical info is missing (Gender/Status)\n            // or if the profile itself hasn't been synced from auth yet\n            if (!profile || !profile.gender || !profile.status) {\n                console.log(\"âš ï¸ Incomplete or missing profile detected, opening setup modal.\");\n                setSetupData({\n                    username: profile?.username || '',\n                    gender: profile?.gender || '',\n                    status: profile?.status || '',\n                    relationshipStatus: profile?.relationship_status || '',\n                });\n                setShowProfileSetup(true);\n            }\n\n            if (profile) {\n                setCurrentUser(profile);\n            }\n\n            // Only consider setupCompleteLocal if the profile ACTUALLY has the required fields\n            const isActuallyComplete = profile && profile.gender && profile.status;\n\n            if (setupCompleteLocal && isActuallyComplete) {\n                // Still potentially fix critical data silently, but don't block\n            } else if (profile) {\n                // 1. Silently fix missing username (common with OAuth)\n                if (!profile.username) {\n                    const baseName = (profile.full_name || 'user').replace(/\\s+/g, '_').toLowerCase().replace(/[^a-z0-9_]/g, '');\n                    const newUsername = `${baseName}_${Math.floor(1000 + Math.random() * 9000)}`;\n\n                    await supabase.from('profiles').update({ username: newUsername }).eq('id', profile.id);\n\n                    // Update connection to avoid race condition in next check\n                    profile.username = newUsername;\n\n                    if (currentUser?.id === profile.id) {\n                        const updated = { ...currentUser, username: newUsername };\n                        setCurrentUser(updated);\n                        localStorage.setItem('currentUser', JSON.stringify(updated));\n                    }\n                }\n\n                // 2. Check VISIBLE mandatory fields (Gender, Status)\n                if (!profile.gender || !profile.status) {\n                    const baseName = (profile.full_name || 'user').replace(/\\s+/g, '_').toLowerCase().replace(/[^a-z0-9_]/g, '');\n                    const defaultUsername = `${baseName}_${Math.floor(1000 + Math.random() * 9000)}`;\n\n                    setSetupData({\n                        gender: profile.gender || '',\n                        status: profile.status || '',\n                        relationshipStatus: profile.relationship_status || '',\n                        username: profile.username || defaultUsername\n                    });\n                    setShowProfileSetup(true);\n                    setLoading(false);\n                }\n\n                // 2.5 Priority Self-Healing: Restore uploaded avatar if Profile reverted to default\n                const metaAvatar = user.user_metadata?.avatar_url;\n                const profileAvatar = profile.avatar_url;\n\n                if (metaAvatar && metaAvatar.startsWith('http') && (!profileAvatar || profileAvatar.startsWith('/defaults/') || profileAvatar.includes('dicebear'))) {\n                    console.log(\"ğŸš‘ [MapHome] Healing avatar mismatch...\", { metaAvatar, profileAvatar });\n\n                    // Update DB\n                    await supabase.from('profiles').update({ avatar_url: metaAvatar }).eq('id', profile.id);\n\n                    // Update Local immediately so UI reflects it\n                    profile.avatar_url = metaAvatar;\n                    if (profile.id === currentUser?.id) {\n                        const updated = { ...currentUser, avatar_url: metaAvatar };\n                        setCurrentUser(updated);\n                        localStorage.setItem('currentUser', JSON.stringify(updated));\n                    }\n                }\n\n                // Check if user needs a new avatar\n                // Assign avatar if:\n                // 1. No avatar exists\n                // 2. Has Google profile picture (OAuth users)\n                // 3. Has old/invalid avatar system\n                else if (!profile.avatar_url ||\n                    profile.avatar_url.includes('googleusercontent.com') ||\n                    profile.avatar_url.includes('lh3.googleusercontent.com')) {\n\n                    // Generate specific default avatar based on gender (User Request)\n                    const gender = profile.gender || 'Other';\n                    let newAvatar;\n\n                    if (gender === 'Male') {\n                        newAvatar = '/defaults/male_avatar.jpg';\n                    } else if (gender === 'Female') {\n                        newAvatar = '/defaults/female_avatar.jpg';\n                    } else {\n                        const baseName = (profile.username || profile.full_name || 'user').replace(/\\s+/g, '_').toLowerCase();\n                        newAvatar = `https://api.dicebear.com/9.x/adventurer/svg?seed=${baseName}_${Math.floor(Math.random() * 1000)}&backgroundColor=b6e3f4,c0aede,d1d4f9`;\n                    }\n\n                    // Auto-save immediately\n                    await supabase.from('profiles')\n                        .update({ avatar_url: newAvatar })\n                        .eq('id', profile.id);\n\n                    // Update local state if current user\n                    if (profile.id === currentUser?.id) {\n                        const updated = { ...currentUser, avatar_url: newAvatar };\n                        setCurrentUser(updated);\n                        localStorage.setItem('currentUser', JSON.stringify(updated));\n                    }\n\n                    // Update profile ref for UI\n                    profile.avatar_url = newAvatar;\n                }\n            }\n        };\n        checkUser();\n    }, []);\n\n    // Global Unread Count Logic\n    const [unreadCount, setUnreadCount] = useState(0);\n\n    useEffect(() => {\n        if (!currentUser?.id) return;\n\n        // Fetch initial count\n        const fetchUnread = async () => {\n            const { count, error } = await supabase\n                .from('messages')\n                .select('id', { count: 'exact', head: true })\n                .eq('receiver_id', currentUser.id)\n                .eq('is_read', false);\n            if (!error) setUnreadCount(count || 0);\n        };\n        fetchUnread();\n\n        // Subscribe to new messages\n        const channel = supabase\n            .channel('global_unread')\n            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `receiver_id=eq.${currentUser.id}` }, async (payload) => {\n                const newMessage = payload.new;\n                setUnreadCount(prev => prev + 1);\n\n                // Check mute settings before notifying\n                const { data: muteData } = await supabase\n                    .from('chat_settings')\n                    .select('muted_until')\n                    .eq('user_id', currentUser.id)\n                    .eq('partner_id', newMessage.sender_id)\n                    .maybeSingle();\n\n                const isMuted = muteData?.muted_until && new Date(muteData.muted_until) > new Date();\n\n                if (!isMuted) {\n                    showToast(`New message from user! ğŸ“©`);\n                }\n            })\n            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'messages', filter: `receiver_id=eq.${currentUser.id}` }, async () => {\n                // Re-fetch if messages are marked read elsewhere\n                fetchUnread();\n            })\n            .subscribe();\n\n        // Listen for all friendship changes\n        const friendshipChannel = supabase\n            .channel('friendships_changes_map')\n            .on('postgres_changes', {\n                event: '*',\n                schema: 'public',\n                table: 'friendships'\n            }, (payload) => {\n                const { eventType, old: oldRec, new: newRec } = payload;\n\n                // CASE 1: DELETE (Unfriend)\n                if (eventType === 'DELETE') {\n                    const deletedId = oldRec.id;\n                    const partnerId = friendshipsRef.current.get(deletedId);\n\n                    if (partnerId) {\n                        friendshipsRef.current.delete(deletedId);\n                        // Reset status in UI\n                        setSelectedUser(prev => prev && prev.id === partnerId ? { ...prev, friendshipStatus: null } : prev);\n                        setNearbyUsers(prev => prev.map(u => u.id === partnerId ? { ...u, friendshipStatus: null } : u));\n                        showToast(\"Friend removed. You can now poke them again.\");\n                    }\n                    return;\n                }\n\n                // Identify partner for INSERT/UPDATE\n                const relevantId = newRec?.requester_id === currentUser.id ? newRec.receiver_id\n                    : newRec?.receiver_id === currentUser.id ? newRec.requester_id\n                        : null;\n\n                if (!relevantId) return;\n\n                // CASE 2: BLOCKED\n                if (newRec?.status === 'blocked') {\n                    window.location.reload();\n                    return;\n                }\n\n                // CASE 3: ACCEPTED\n                if (newRec?.status === 'accepted') {\n                    friendshipsRef.current.set(newRec.id, relevantId); // Cache it\n                    showToast(`Friend request accepted! ğŸ‰`);\n                    setSelectedUser(prev => prev && prev.id === relevantId ? { ...prev, friendshipStatus: 'accepted' } : prev);\n                    setNearbyUsers(prev => prev.map(u => u.id === relevantId ? { ...u, friendshipStatus: 'accepted' } : u));\n                }\n\n                // CASE 4: PENDING (New Poke)\n                if (newRec?.status === 'pending') {\n                    friendshipsRef.current.set(newRec.id, relevantId); // Cache it\n\n                    const isIncoming = newRec.receiver_id === currentUser.id;\n                    if (isIncoming) {\n                        showToast(`New Poke received! ğŸ‘‹`);\n                    }\n\n                    // Update UI\n                    setSelectedUser(prev => prev && prev.id === relevantId ? {\n                        ...prev,\n                        friendshipStatus: 'pending',\n                        requesterId: newRec.requester_id,\n                        friendshipId: newRec.id\n                    } : prev);\n\n                    setNearbyUsers(prev => prev.map(u => u.id === relevantId ? {\n                        ...u,\n                        friendshipStatus: 'pending',\n                        requesterId: newRec.requester_id,\n                        friendshipId: newRec.id\n                    } : u));\n                }\n            })\n            .subscribe();\n\n        return () => {\n            supabase.removeChannel(channel);\n            supabase.removeChannel(friendshipChannel);\n        };\n    }, [currentUser, userLocation]);\n\n    // Poll for nearby users\n    useEffect(() => {\n        if (!currentUser) return; // Wait for user, but don't need location to fetch others\n\n        const fetchNearbyUsers = async () => {\n            if (!currentUser?.id) return; // Prevent API calls if user not loaded\n\n            try {\n                // Fetch blocked user IDs (both directions - users I blocked and users who blocked me)\n                const [blockedByMe, blockedMe] = await Promise.all([\n                    getBlockedUserIds(currentUser.id),  // Users I blocked\n                    getBlockerIds(currentUser.id)        // Users who blocked me\n                ]);\n\n                // Combine both lists for mutual hiding\n                const allBlockedIds = new Set([...blockedByMe, ...blockedMe]);\n                blockedIdsRef.current = allBlockedIds; // Update Ref for real-time subscriptions\n\n                // Run queries in parallel for faster loading\n                const [profilesResult, friendshipResult, storiesResult, viewsResult] = await Promise.all([\n                    // Fetch all profiles with only needed fields\n                    supabase\n                        .from('profiles')\n                        .select('id, username, full_name, gender, latitude, longitude, status, relationship_status, status_message, status_updated_at, last_active, avatar_url, hide_status, show_last_seen, is_public, is_location_on')\n                        .neq('id', currentUser.id)\n                        .or('is_ghost_mode.eq.false,is_ghost_mode.is.null') // Allow NULL as false (visible)\n                        .not('latitude', 'is', null)\n                        .not('longitude', 'is', null),\n\n                    // Fetch my friendships (to sync map)\n                    supabase\n                        .from('friendships')\n                        .select('id, requester_id, receiver_id, status')\n                        .or(`requester_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`),\n\n                    // Fetch Active Stories (Last 24h)\n                    supabase\n                        .from('stories')\n                        .select('id, user_id')\n                        .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()),\n\n                    // Fetch my story views (to distinguish Seen/Unseen)\n                    supabase\n                        .from('story_views')\n                        .select('story_id')\n                        .eq('viewer_id', currentUser.id)\n                ]);\n\n                // Populate friendships map\n                const myFriendships = new Map();\n\n                if (friendshipResult.data) {\n                    friendshipResult.data.forEach(f => {\n                        const partnerId = f.requester_id === currentUser.id ? f.receiver_id : f.requester_id;\n                        if (f.status === 'accepted') {\n                            friendshipsRef.current.set(f.id, partnerId);\n                            myFriendships.set(partnerId, { status: 'accepted', id: f.id });\n                        }\n                        if (f.status === 'pending') {\n                            // Cache pending ID too for deletion lookup\n                            friendshipsRef.current.set(f.id, partnerId);\n                            myFriendships.set(partnerId, {\n                                status: 'pending',\n                                id: f.id,\n                                requesterId: f.requester_id // Store requester to know direction\n                            });\n                        }\n                    });\n                }\n\n                // Process Stories & Views\n                const usersWithStories = new Set();\n                const usersWithUnseenStories = new Set();\n\n                const myViewedStoryIds = new Set(\n                    viewsResult.data ? viewsResult.data.map(v => v.story_id) : []\n                );\n\n                if (storiesResult.data) {\n                    // Group stories by user\n                    const storiesByUser = {};\n                    storiesResult.data.forEach(s => {\n                        if (!storiesByUser[s.user_id]) storiesByUser[s.user_id] = [];\n                        storiesByUser[s.user_id].push(s);\n                        usersWithStories.add(s.user_id);\n                    });\n\n                    // Check for unseen\n                    Object.keys(storiesByUser).forEach(userId => {\n                        const userStories = storiesByUser[userId];\n                        const hasUnseen = userStories.some(s => !myViewedStoryIds.has(s.id));\n                        if (hasUnseen) {\n                            usersWithUnseenStories.add(userId);\n                        }\n                    });\n                }\n\n                // Debug: Log raw fetch results\n                if (profilesResult.error) {\n                    console.error('âŒ [MapHome] Fetch Error:', profilesResult.error);\n                }\n                console.log('ğŸ“ [MapHome] Raw Profiles Fetched:', profilesResult.data?.length, profilesResult.data);\n\n                // Filter and map users (exclude blocked users, those with location off, AND current user)\n                const validUsers = (profilesResult.data || [])\n                    .filter(u => {\n                        const isBlocked = allBlockedIds.has(u.id);\n                        const isMe = u.id === currentUser.id;\n                        const isLocationOff = u.is_location_on === false; // Strict check? Or checking for NULL?\n                        // Query already filters .eq('is_location_on', true). So u.is_location_on SHOULD be true.\n                        // But if query failed to filter?\n                        \n                        if (isBlocked || isMe || isLocationOff) {\n                            // console.log(`ğŸš« Filtering User ${u.username}: Blocked=${isBlocked}, Me=${isMe}, LocOff=${isLocationOff}`);\n                            return false;\n                        }\n                        return true;\n                    })\n                    .map(u => {\n                        // Use actual avatar if available, otherwise gender-based fallback\n                        const safeName = encodeURIComponent(u.username || u.full_name || 'User');\n                        // Standardized Fallback Logic (No DiceBear)\n                        let fallbackAvatar;\n                        if (u.gender === 'Male') fallbackAvatar = DEFAULT_MALE_AVATAR;\n                        else if (u.gender === 'Female') fallbackAvatar = DEFAULT_FEMALE_AVATAR;\n                        else fallbackAvatar = DEFAULT_GENERIC_AVATAR;\n\n                        // Micro-jitter for initial load\n                        // Ensure we work with Numbers\n                        const lat = parseFloat(u.latitude);\n                        const lng = parseFloat(u.longitude);\n                        const renderLat = lat + (Math.random() - 0.5) * 0.0002;\n                        const renderLng = lng + (Math.random() - 0.5) * 0.0002;\n\n                        // Get friendship data from map\n                        const fData = myFriendships.get(u.id);\n\n                        // Check Status Expiration (3 Hours)\n                        let statusMessage = u.status_message;\n                        let statusEmoji = u.status;\n                        \n                        if (u.status_updated_at) {\n                            const statusDate = new Date(u.status_updated_at);\n                            const now = new Date();\n                            const diffHours = (now - statusDate) / (1000 * 60 * 60);\n                            \n                            if (diffHours > 3) {\n                                statusMessage = null;\n                                statusEmoji = null;\n                            }\n                        }\n\n                        return {\n                            id: u.id,\n                            name: u.username || 'User',\n                            lat: renderLat,\n                            lng: renderLng,\n                            avatar: u.avatar_url || fallbackAvatar, // Use real avatar if exists\n                            originalAvatar: u.avatar_url,\n                            status: statusEmoji,\n                            hide_status: u.hide_status,\n                            show_last_seen: u.show_last_seen,\n                            relationshipStatus: u.relationship_status,\n                            thought: statusMessage,\n                            lastActive: u.last_active,\n                            isLocationOn: u.is_location_on,\n                            isLocationShared: true,\n                            friendshipStatus: fData?.status || null,\n                            friendshipId: fData?.id || null,\n                            is_public: u.is_public,\n                            status_updated_at: u.status_updated_at, // ğŸ”¥ Critical for expiration check\n                            // PRIVACY CHECK: Only show story if public OR friends\n                            hasStory: usersWithStories.has(u.id) && (u.is_public !== false || fData?.status === 'accepted'),\n                            hasUnseenStory: usersWithUnseenStories.has(u.id) && (u.is_public !== false || fData?.status === 'accepted')\n                        };\n                    });\n\n                console.log(\"ğŸ“ [MapHome] Fetched Users:\", validUsers.length, validUsers);\n                validUsers.forEach(u => console.log(`   - ${u.name}: ${u.lat}, ${u.lng} (Avatar: ${u.avatar ? 'Yes' : 'No'})`));\n                setNearbyUsers(prev => {\n                    const map = new Map();\n\n                    // keep existing realtime users\n                    prev.forEach(u => map.set(u.id, u));\n\n                    // update / insert fetched users\n                    validUsers.forEach(u => {\n                        map.set(u.id, {\n                            ...map.get(u.id),\n                            ...u\n                        });\n                    });\n                    return Array.from(map.values());\n                });\n            } catch (err) {\n                console.error(err);\n            }\n        };\n\n        // Real-time Subscription for Instant Updates (both UPDATE and INSERT)\n        const channel = supabase\n            .channel('public:profiles')\n            // Unified UPDATE listener for Location + Profile changes\n            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profiles' }, (payload) => {\n                console.log(\"ğŸ“ [MapHome] Realtime UPDATE received:\", payload);\n                const updatedUser = payload.new;\n\n                console.log(\"Realtime UPDATE:\", {\n                    username: updatedUser.username,\n                    is_location_on: updatedUser.is_location_on,\n                    is_ghost_mode: updatedUser.is_ghost_mode,\n                    latitude: updatedUser.latitude,\n                    longitude: updatedUser.longitude\n                });\n\n                if (updatedUser.id === currentUser.id) return; // Skip self\n\n                // FILTER BLOCKED USERS\n                if (blockedIdsRef.current.has(updatedUser.id)) {\n                    // Start removing them if they are currently on map\n                    setNearbyUsers(prev => prev.filter(u => u.id !== updatedUser.id));\n                    return;\n                }\n\n                // Check visibility criteria\n                const hasLocation =\n                    updatedUser.latitude != null &&\n                    updatedUser.longitude != null;\n\n                const isVisible =\n                    updatedUser.is_location_on !== false &&\n                    updatedUser.is_ghost_mode !== true &&\n                    updatedUser.latitude != null &&\n                    updatedUser.longitude != null;\n\n\n\n                setNearbyUsers(prev => {\n                    const existingIndex = prev.findIndex(u => u.id === updatedUser.id);\n                    const exists = existingIndex !== -1;\n\n                    if (isVisible) {\n                        // Prepare consistent avatar logic\n                        const mapAvatar = updatedUser.avatar_url;\n\n                        // Use EXACT coordinates for smooth updates (No Jitter on updates)\n                        // Use EXACT coordinates for smooth updates (No Jitter on updates)\n                        const renderLat = parseFloat(updatedUser.latitude);\n                        const renderLng = parseFloat(updatedUser.longitude);\n\n                        const newUserObj = {\n                            id: updatedUser.id,\n                            name: updatedUser.username || 'User',\n                            lat: renderLat,\n                            lng: renderLng,\n                            avatar: mapAvatar,\n                            originalAvatar: updatedUser.avatar_url,\n                            status: updatedUser.status,\n                            thought: updatedUser.status_message,\n                            lastActive: updatedUser.last_active,\n                            isLocationShared: true,\n\n                            isLocationOn: updatedUser.is_location_on,\n                            relationshipStatus: updatedUser.relationship_status,\n\n                            status_updated_at: updatedUser.status_updated_at,\n                            is_public: updatedUser.is_public,\n\n                            friendshipStatus: exists\n                                ? prev[existingIndex].friendshipStatus\n                                : null,\n\n                            hasStory: exists\n                                ? (\n                                    prev[existingIndex].hasStory &&\n                                    (updatedUser.is_public !== false ||\n                                    prev[existingIndex].friendshipStatus === 'accepted')\n                                )\n                                : false,\n\n                            hasUnseenStory: exists\n                                ? (\n                                    prev[existingIndex].hasUnseenStory &&\n                                    (updatedUser.is_public !== false ||\n                                    prev[existingIndex].friendshipStatus === 'accepted')\n                                )\n                                : false\n                        };\n\n\n                        if (exists) {\n                            // Update existing user\n                            const newUsers = [...prev];\n                            newUsers[existingIndex] = { ...newUsers[existingIndex], ...newUserObj };\n                            return newUsers;\n                        } else {\n                            // Add new user\n                            return [...prev, newUserObj];\n                        }\n                    } else {\n                        // User should not be visible (ghost mode or no location)\n                        if (exists) {\n                            return prev.filter(u => u.id !== updatedUser.id); // Remove\n                        }\n                        return prev; // Do nothing\n                    }\n                });\n            })\n            // Listen for new user logins (INSERT events)\n            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'profiles' }, (payload) => {\n                const newUser = payload.new;\n                if (!newUser.latitude || !newUser.longitude) return;\n                if (newUser.id === currentUser.id) return; // Skip self\n\n                // FILTER BLOCKED USERS\n                if (blockedIdsRef.current.has(newUser.id)) return;\n\n                // Show new user if not in ghost mode and location is on\n                if (\n                    newUser.is_location_on === true &&\n                    newUser.is_ghost_mode === false &&\n                    newUser.latitude != null &&\n                    newUser.longitude != null\n                ) {\n\n                    // Preload Image Immediately\n                    const mapAvatar = newUser.avatar_url;\n\n                    // Preload Image Immediately\n                    const img = new Image();\n                    img.src = mapAvatar;\n\n                   setNearbyUsers(prev => {\n                        // Avoid duplicates\n                        if (prev.some(u => u.id === newUser.id)) return prev;\n\n                        // Add new user\n                        return [...prev, {\n                            id: newUser.id,\n                            name: newUser.username || 'User',\n                            lat: parseFloat(newUser.latitude),\n                            lng: parseFloat(newUser.longitude),\n                            avatar: mapAvatar,\n                            originalAvatar: newUser.avatar_url,\n                            status: newUser.status,\n                            thought: newUser.status_message,\n                            lastActive: newUser.last_active,\n\n                            isLocationOn: true,\n                            isLocationShared: true,\n                            relationshipStatus: newUser.relationship_status,\n\n                            status_updated_at: newUser.status_updated_at,\n                            is_public: newUser.is_public,\n\n                            friendshipStatus: null,\n                            hasStory: false,\n                            hasUnseenStory: false\n                        }];\n                    });\n                }\n            })\n\n            // Real-time Story Updates (Ring Indicator)\n            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'stories' }, (payload) => {\n                const story = payload.new;\n                setNearbyUsers(prev => prev.map(u => {\n                    if (u.id === story.user_id) {\n                        // Check privacy before showing ring\n                        const isFriend = u.friendshipStatus === 'accepted';\n                        const isPublic = u.is_public !== false;\n                        if (isFriend || isPublic) {\n                            return { ...u, hasStory: true, hasUnseenStory: true };\n                        }\n                    }\n                    return u;\n                }));\n            })\n            .subscribe();\n\n\n        const interval = setInterval(fetchNearbyUsers, 30000); // Poll every 30s (Realtime handles immediate changes)\n        fetchNearbyUsers(); // Initial fetch\n\n        return () => {\n            clearInterval(interval);\n            supabase.removeChannel(channel);\n        };\n    }, [currentUser]); // ğŸ”¥ Removed userLocation to prevent re-fetching on every move\n\n    // Live Location is now handled entirely by LocationContext.\n    // We just listen to userLocation via the useEffect above.\n    // Removed redundant local watcher to prevent kCLErrorLocationUnknown and resource contention. \n\n    // Preload avatar images to eliminate lag\n    useEffect(() => {\n        const preloadImage = (url) => {\n            if (!url) return;\n            const img = new Image();\n            img.src = url;\n        };\n\n        // Preload current user avatar\n        if (currentUser?.avatar_url) {\n            const avatar2D = getAvatar2D(currentUser.avatar_url);\n            preloadImage(avatar2D);\n        }\n\n        // Preload nearby users avatars\n        nearbyUsers.forEach(user => {\n            if (user.avatar) {\n                const avatar2D = user.avatar.includes('.glb') ? getAvatar2D(user.avatar) : user.avatar;\n                preloadImage(avatar2D);\n            }\n        });\n    }, [currentUser, nearbyUsers]);\n\n\n    // Auth & Location Tracking\n    useEffect(() => {\n        const userStr = localStorage.getItem('currentUser');\n        if (!userStr) {\n            navigate('/login');\n            return;\n        }\n        const parsedUser = JSON.parse(userStr);\n        // Optimistically set from cache first\n        setCurrentUser(parsedUser);\n\n        // FETCH FRESH PROFILE (Critical for syncing Gender/Avatar updates)\n        const refreshProfile = async () => {\n            const { data: freshProfile } = await supabase\n                .from('profiles')\n                .select('*')\n                .eq('id', parsedUser.id)\n                .maybeSingle();\n\n            if (freshProfile) {\n                // Version Check for Avatar: Optimistic local update might be newer than DB\n                let finalAvatarUrl = freshProfile.avatar_url;\n                if (parsedUser.avatar_url && freshProfile.avatar_url) {\n                    const getTimestamp = (url) => {\n                        const match = url ? url.match(/t=(\\d+)/) : null;\n                        return match ? parseInt(match[1]) : 0;\n                    };\n                    const localTs = getTimestamp(parsedUser.avatar_url);\n                    const remoteTs = getTimestamp(freshProfile.avatar_url);\n                    if (localTs > remoteTs) {\n                        finalAvatarUrl = parsedUser.avatar_url; // Keep optimistic local version\n                    }\n                }\n\n                const mergedUser = { ...parsedUser, ...freshProfile, avatar_url: finalAvatarUrl };\n                // Ensure we map snake_case DB fields to camelCase if needed, \n                // but looks like we use mixed. Let's standardize on DB structure + local adds\n\n                // Optimistically set location from DB to prevent \"Acquiring Location\" lag\n                // Note: Real-time location is handled by LocationContext\n                if (freshProfile.latitude && freshProfile.longitude && !userLocation) {\n                    // We could potentially seed the context here if needed, but Context handles its own startup\n                    // promoting separation of concerns.\n                }\n\n                setCurrentUser(mergedUser);\n                localStorage.setItem('currentUser', JSON.stringify(mergedUser));\n\n                // Secondary Failsafe: Ensure OAuth users see the modal even if the first effect missed it\n                const setupCompleteLocal = localStorage.getItem('setup_complete') === 'true';\n                if (!setupCompleteLocal && (!freshProfile.gender || !freshProfile.status)) {\n                    console.log(\"âš ï¸ [refreshProfile Failsafe] Incomplete profile detected, opening setup modal.\");\n                    setSetupData({\n                        username: freshProfile.username || '',\n                        gender: freshProfile.gender || '',\n                        status: freshProfile.status || '',\n                        relationshipStatus: freshProfile.relationship_status || '',\n                    });\n                    setShowProfileSetup(true);\n                }\n            }\n            setLoading(false); // Fix: dismiss loading screen as soon as profile is handled\n        };\n        refreshProfile();\n\n        // Listen for local updates from Profile page (optimistic updates)\n        const handleLocalUpdate = () => {\n            const stored = localStorage.getItem('currentUser');\n            if (stored) {\n                setCurrentUser(JSON.parse(stored));\n            }\n        };\n        window.addEventListener('local-user-update', handleLocalUpdate);\n\n        // Subscribe to my own profile changes (avatar, status updates)\n        const profileSub = supabase\n            .channel(`public:profiles:${parsedUser.id}`)\n            .on('postgres_changes', {\n                event: 'UPDATE',\n                schema: 'public',\n                table: 'profiles',\n                filter: `id=eq.${parsedUser.id}`\n            }, (payload) => {\n                setCurrentUser(prev => {\n                    const updated = { ...prev, ...payload.new };\n                    localStorage.setItem('currentUser', JSON.stringify(updated));\n                    return updated;\n                });\n            })\n            .subscribe();\n\n        return () => {\n            if (profileSub) supabase.removeChannel(profileSub);\n            window.removeEventListener('local-user-update', handleLocalUpdate);\n        };\n    }, [navigate]);\n\n\n\n    const handlePermissionSelect = (choice) => {\n        if (choice === 'while-using' || choice === 'once') {\n            startLocation(); // Direct call to preserve user gesture on mobile\n        }\n        // Note: Deny case intentionally does nothing - user just dismisses modal\n    };\n\n\n    const handleEnableLocation = async () => {\n        // Optimistically unblock map\n        setCurrentUser(prev => ({ ...prev, is_location_on: true }));\n        \n        // Request permission (will update DB on success)\n        startLocation();\n\n    };\n\n    const showToast = (msg) => {\n        setToastMsg(msg);\n        setTimeout(() => setToastMsg(null), 3000);\n    };\n\n    const startCamera = async () => {\n        setIsCameraOpen(true);\n        try {\n            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: \"user\" } });\n            if (videoRef.current) videoRef.current.srcObject = stream;\n        } catch (err) {\n            console.error(\"Camera error\", err);\n            showToast(\"Camera access failed\");\n            setIsCameraOpen(false);\n        }\n    };\n\n    const capturePhoto = () => {\n        if (videoRef.current && canvasRef.current) {\n            const context = canvasRef.current.getContext('2d');\n            canvasRef.current.width = videoRef.current.videoWidth;\n            canvasRef.current.height = videoRef.current.videoHeight;\n            context.drawImage(videoRef.current, 0, 0);\n            const dataUrl = canvasRef.current.toDataURL('image/jpeg', 0.8);\n            setOnboardingImage(dataUrl);\n            const stream = videoRef.current.srcObject;\n            if (stream) stream.getTracks().forEach(t => t.stop());\n            setIsCameraOpen(false);\n        }\n    };\n\n    const handleCompleteSetup = async () => {\n        if (!setupData.gender || !setupData.relationshipStatus) {\n            showToast(\"Please select Gender and Relationship Status!\");\n            return;\n        }\n\n        try {\n            showToast(\"Saving profile... â³\");\n\n            let userId = currentUser?.id;\n            if (!userId) {\n                const { data: { session } } = await supabase.auth.getSession();\n                const user = session?.user;\n                if (!user) throw new Error(\"No authenticated user found.\");\n                userId = user.id;\n            }\n\n            // 1. Determine Avatar URL (Upload > Gender Default)\n            let finalAvatarUrl;\n\n            // Priority 1: Uploaded File\n            if (avatarFile) {\n                // Upload to 'chat-images' using userId as folder prefix if possible, or just unique name\n                // Using existing uploadToStorage utility\n                const { fileUrl, error: uploadError } = await uploadToStorage(avatarFile, userId, null, 'chat-images'); // Using chat-images as it's public\n                if (uploadError) throw new Error(\"Image upload failed: \" + uploadError.message);\n                finalAvatarUrl = fileUrl;\n            } else {\n                // Priority 2: Gender Default\n                if (setupData.gender === 'Male') finalAvatarUrl = DEFAULT_MALE_AVATAR;\n                else if (setupData.gender === 'Female') finalAvatarUrl = DEFAULT_FEMALE_AVATAR;\n                else finalAvatarUrl = DEFAULT_GENERIC_AVATAR;\n            }\n\n            // Update Profile\n            const updates = {\n                gender: setupData.gender,\n                // status: setupData.status, // Don't overwrite status here, let it be default or whatever it was\n                relationship_status: setupData.relationshipStatus,\n                username: setupData.username,\n                avatar_url: finalAvatarUrl\n            };\n            \n            // If status is empty, set a default \"Available\"\n            if (!setupData.status) {\n                updates.status = 'Available';\n            } else {\n                updates.status = setupData.status;\n            }\n\n            // Validate username\n            if (!updates.username) {\n                showToast(\"Username is required!\");\n                return;\n            }\n\n            const { error: updateError } = await supabase\n                .from('profiles')\n                .update(updates)\n                .eq('id', userId);\n\n            if (updateError) {\n                console.error(\"DB Error:\", updateError);\n                throw new Error(\"DB Update Failed: \" + updateError.message);\n            }\n\n            showToast(\"Profile Complete! Welcome! ğŸ‰\");\n            setShowProfileSetup(false);\n\n            // Optimistic Update\n            setCurrentUser(prev => ({\n                ...prev,\n                id: userId,\n                ...updates\n            }));\n\n            // Sync to LocalStorage\n            const updatedUser = {\n                ...currentUser,\n                id: userId,\n                ...updates\n            };\n            localStorage.setItem('currentUser', JSON.stringify(updatedUser));\n            localStorage.setItem('setup_complete', 'true');\n\n        } catch (error) {\n            console.error(\"Setup Error:\", error);\n            showToast(`Setup Failed: ${error.message}`);\n        }\n    };\n\n    const handleDeleteThought = async () => {\n        if (!currentUser) return;\n\n        try {\n            // Optimistic update\n            const updatedUser = { ...currentUser, thought: null, thoughtTime: null };\n            setCurrentUser(updatedUser);\n            setMyThought(''); // Clear input\n            localStorage.setItem('currentUser', JSON.stringify(updatedUser));\n            setShowThoughtInput(false);\n\n            // DB Update\n            const { error } = await supabase\n                .from('profiles')\n                .update({\n                    status_message: null,\n                    status_updated_at: null\n                })\n                .eq('id', currentUser.id);\n\n            if (error) throw error;\n            showToast('Thought removed');\n        } catch (err) {\n            console.error(\"Error deleting thought:\", err);\n            showToast(\"Failed to remove thought\");\n        }\n    };\n\n    const handlePostThought = async (e) => {\n        e.preventDefault();\n        if (!currentUser) return;\n\n        try {\n            // Optimistic update\n            const updatedUser = { ...currentUser, thought: myThought, thoughtTime: Date.now() };\n            setCurrentUser(updatedUser);\n            localStorage.setItem('currentUser', JSON.stringify(updatedUser));\n            setShowThoughtInput(false);\n\n            // DB Update for global visibility\n            const { error } = await supabase\n                .from('profiles')\n                .update({\n                    status_message: myThought,\n                    last_active: new Date().toISOString(),\n                    status_updated_at: new Date().toISOString()\n                })\n                .eq('id', currentUser.id);\n\n            if (error) throw error;\n            \n            setNearbyUsers(prev =>\n            prev.map(u =>\n                u.id === currentUser.id\n                    ? {\n                        ...u,\n                        thought: myThought,\n                        status_updated_at: now,\n                        lastActive: now\n                      }\n                    : u\n            )\n        );\n\n            showToast('Thought posted to map! ğŸŒ');\n        } catch (err) {\n            console.error(\"Error posting thought:\", err);\n            showToast(\"Failed to post thought\");\n        }\n    };\n\n    // Calculate distance between two coordinates in meters (Haversine formula)\n    const calculateDistance = (lat1, lon1, lat2, lon2) => {\n        const R = 6371e3; // Earth's radius in meters\n        const Ï†1 = lat1 * Math.PI / 180;\n        const Ï†2 = lat2 * Math.PI / 180;\n        const Î”Ï† = (lat2 - lat1) * Math.PI / 180;\n        const Î”Î» = (lon2 - lon1) * Math.PI / 180;\n\n        const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +\n            Math.cos(Ï†1) * Math.cos(Ï†2) *\n            Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);\n        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n        return R * c; // Distance in meters\n    };\n\n    const handleUserAction = async (action, targetUser) => {\n        if (!currentUser) return;\n\n        if (action === 'message') {\n            // Check if friends first\n            const { data } = await supabase\n                .from('friendships')\n                .select('*')\n                .or(`and(requester_id.eq.${currentUser.id},receiver_id.eq.${targetUser.id}),and(requester_id.eq.${targetUser.id},receiver_id.eq.${currentUser.id})`)\n                .eq('status', 'accepted')\n                .maybeSingle();\n\n            if (data) {\n                const chatUser = {\n                    ...targetUser,\n                    avatar_url: targetUser.avatar_url || targetUser.avatar, // Ensure Chat gets a URL\n                    name: targetUser.name || targetUser.username || targetUser.full_name // Ensure Name\n                };\n                navigate('/chat', { state: { targetUser: chatUser } });\n            } else {\n                showToast(\"You need to be friends to chat! Poke them first. ğŸ‘‰\");\n            }\n        }\n        else if (action === 'poke') {\n            try {\n                // 1. Check Block Status (New Table)\n                const isBlocked = await isUserBlocked(targetUser.id, currentUser.id); // target blocked me\n                if (isBlocked) {\n                    showToast(\"Failed to send poke.\");\n                    return;\n                }\n                const iBlocked = await isUserBlocked(currentUser.id, targetUser.id); // I blocked target\n                if (iBlocked) {\n                    showToast(\"Unblock user to poke them.\");\n                    return;\n                }\n\n                // 2. Check if already friends or requested\n                const { data: existing } = await supabase\n                    .from('friendships')\n                    .select('*')\n                    .or(`and(requester_id.eq.${currentUser.id},receiver_id.eq.${targetUser.id}),and(requester_id.eq.${targetUser.id},receiver_id.eq.${currentUser.id})`)\n                    .maybeSingle();\n\n                if (existing) {\n                    if (existing.status === 'accepted') {\n                        showToast(`You are already friends with ${targetUser.name}!`);\n                        return;\n                    }\n                    else if (existing.status === 'pending') {\n                        // Check who sent the request\n                        if (existing.requester_id === currentUser.id) {\n                            showToast(`Poke already sent to ${targetUser.name}!`);\n                            return;\n                        } else {\n                            // THEY sent the request, and I am Poking them back -> ACCEPT IT!\n                            const { error: acceptError } = await supabase\n                                .from('friendships')\n                                .update({ status: 'accepted' })\n                                .eq('id', existing.id);\n\n                            if (acceptError) throw acceptError;\n\n                            showToast(`You and ${targetUser.name} are now friends! ğŸ¤`);\n                            setSelectedUser((prev) => ({ ...prev, friendshipStatus: 'accepted' }));\n                            return;\n                        }\n                    }\n\n                    // For 'declined' OR 'blocked' status (legacy), we delete and start fresh\n                    const { error: deleteError } = await supabase\n                        .from('friendships')\n                        .delete()\n                        .eq('id', existing.id);\n\n                    if (deleteError) {\n                        console.error('Error deleting existing record:', deleteError);\n                        // Fallback: try update to pending\n                        await supabase\n                            .from('friendships')\n                            .update({\n                                status: 'pending',\n                                requester_id: currentUser.id,\n                                receiver_id: targetUser.id\n                            })\n                            .eq('id', existing.id);\n\n                        showToast(`ğŸ‘‹ Poked ${targetUser.name}!`);\n                        setSelectedUser({ ...targetUser, friendshipStatus: 'pending' });\n                        return;\n                    }\n                }\n\n                // OPTIMISTIC UPDATE: Show \"Requested\" immediately\n                showToast(`Poke Request Sent ğŸ“¨`);\n\n                // Track previous state for rollback\n                const prevSelectedUser = { ...selectedUser };\n\n                setSelectedUser({\n                    ...targetUser,\n                    friendshipStatus: 'pending',\n                    requesterId: currentUser.id,\n                    // Temporary ID or null, will update after DB\n                    friendshipId: 'temp-' + Date.now()\n                });\n\n                // Send Poke Request\n                const { data: newRecs, error } = await supabase\n                    .from('friendships')\n                    .insert({\n                        requester_id: currentUser.id,\n                        receiver_id: targetUser.id,\n                        status: 'pending'\n                    })\n                    .select();\n\n                if (error) {\n                    // Revert UI on error\n                    setSelectedUser(prevSelectedUser);\n                    console.error('Poke error:', error);\n\n                    if (error.code === '23505') {\n                        console.warn('Handling duplicate poke insert...');\n                        // Was already requested maybe? Refresh user?\n                        showToast(\"Poke already sent!\");\n                        // Refetch to get truth\n                    } else {\n                        showToast(\"Failed to send poke.\");\n                        throw error;\n                    }\n                } else {\n                    // Success: Update with real ID so Cancel works\n                    const newFriendship = newRecs[0];\n                    friendshipsRef.current.set(newFriendship.id, targetUser.id);\n\n                    setSelectedUser(prev => ({\n                        ...prev,\n                        friendshipId: newFriendship.id\n                    }));\n                }\n            } catch (err) {\n                // Already handled rollback above for most cases\n            }\n        }\n        else if (action === 'cancel-poke') {\n            try {\n                // Delete the friendship row (cancels request)\n                // Remove from ref first so realtime listener doesn't show duplicate toast\n                if (targetUser.friendshipId) {\n                    friendshipsRef.current.delete(targetUser.friendshipId);\n                }\n\n                const { error } = await supabase\n                    .from('friendships')\n                    .delete()\n                    .eq('id', targetUser.friendshipId);\n\n                if (error) throw error;\n\n                showToast(\"Request cancelled âŒ\");\n\n                // Update UI immediately (Revert to no status)\n                setSelectedUser({\n                    ...targetUser,\n                    friendshipStatus: null,\n                    friendshipId: null,\n                    requesterId: null\n                });\n\n            } catch (err) {\n                console.error('Cancel poke error:', err);\n                showToast(\"Failed to cancel request\");\n            }\n        }\n        else if (action === 'block') {\n            try {\n                // Insert into blocked_users table\n                const { error } = await supabase\n                    .from('blocked_users')\n                    .insert({\n                        blocker_id: currentUser.id,\n                        blocked_id: targetUser.id\n                    });\n\n                if (error) {\n                    // Check if already blocked (unique constraint violation)\n                    if (error.code === '23505') {\n                        showToast(`${targetUser.name} is already blocked`);\n                    } else {\n                        throw error;\n                    }\n                } else {\n                    showToast(`Blocked ${targetUser.name}`);\n                    setSelectedUser(null);\n                    setShowFullProfile(false);\n                    // Also delete friendship if it exists, to remove from map (optional but cleaner)\n                    if (targetUser.friendshipId) {\n                        await supabase.from('friendships').delete().eq('id', targetUser.friendshipId);\n                    }\n                }\n            } catch (err) {\n                console.error('Block error:', err);\n                showToast('Failed to block user');\n            }\n        }\n        else if (action === 'mute') {\n            if (targetUser.isMuted) {\n                // UNMUTE IMMEDIATELY\n                try {\n                    const isRequester = targetUser.requesterId === currentUser.id;\n                    const column = isRequester ? 'muted_until_by_requester' : 'muted_until_by_receiver';\n\n                    await supabase\n                        .from('friendships')\n                        .update({ [column]: null })\n                        .eq('id', targetUser.friendshipId);\n\n                    showToast(`Unmuted ${targetUser.name} ğŸ””`);\n                    setSelectedUser(prev => ({ ...prev, isMuted: false }));\n                } catch (err) {\n                    console.error(\"Unmute error:\", err);\n                    showToast(\"Failed to unmute\");\n                }\n            } else {\n                // OPEN MUTE MODAL for duration selection\n                setMuteTarget(targetUser);\n                setShowMuteModal(true);\n            }\n        }\n        else if (action === 'report') {\n            // Show report modal with reason options\n            setReportTarget(targetUser);\n            setShowReportModal(true);\n            setSelectedUser(null);\n        }\n        else if (action === 'report') {\n            // Show report modal with reason options\n            setReportTarget(targetUser);\n            setShowReportModal(true);\n            setSelectedUser(null);\n            setShowFullProfile(false); // Close full profile if open\n        }\n        else if (action === 'zoom-to-user') {\n            // Triggered by avatar click on mobile - force re-trigger zoom\n            console.log('ğŸ—ºï¸ [MapHome] zoom-to-user triggered for:', targetUser.name);\n            // Force selectedUser update to re-trigger UserSelectionController\n            setSelectedUser(null); // Clear first\n            setTimeout(() => {\n                setSelectedUser(targetUser); // Re-set to trigger zoom\n            }, 50);\n        }\n        else if (action === 'view-profile') {\n            setFullProfileUser(targetUser);\n            setShowFullProfile(true);\n            // Keep selectedUser set so map stays zoomed on mobile\n        }\n        else if (action === 'call-audio' || action === 'call-video') {\n            const isVideo = action === 'call-video';\n            startCall(targetUser.id, isVideo);\n            showToast(`Starting ${isVideo ? 'video' : 'audio'} call... ğŸ“`);\n            setSelectedUser(null);\n            setShowFullProfile(false);\n        }\n        else if (action === 'view-story') {\n            // Fetch active stories for this user\n            const fetchStories = async () => {\n                try {\n                    const { data, error } = await supabase\n                        .from('stories')\n                        .select('*')\n                        .eq('user_id', targetUser.id)\n                        .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())\n                        .order('created_at', { ascending: true });\n\n                    if (error) throw error;\n\n                    if (data && data.length > 0) {\n                        setViewingStoryUser({\n                            user: targetUser,\n                            stories: data\n                        });\n                    } else {\n                        showToast(\"No active stories\");\n                    }\n                } catch (err) {\n                    console.error(\"Error fetching stories:\", err);\n                    showToast(\"Failed to load stories\");\n                }\n            };\n            fetchStories();\n        }\n    };\n\n    const handleReport = async (reason) => {\n        try {\n            await supabase.from('reports').insert({\n                reporter_id: currentUser.id,\n                reported_id: reportTarget.id,\n                reason: reason\n            });\n            showToast(`âš ï¸ Reported ${reportTarget.name}`);\n            setShowReportModal(false);\n            setReportTarget(null);\n        } catch (err) {\n            console.error('Report error:', err);\n            showToast('Failed to submit report');\n        }\n    };\n\n    const iconCache = useRef(new Map());\n\n    const createAvatarIcon = (url, isSelf = false, thought = null, name = '', status = null) => {\n        // Caching the icon object prevents React-Leaflet from destroying the DOM node and allows CSS transitions to run smoothly.\n        const isGhost = isSelf && currentUser?.is_ghost_mode;\n        const cacheKey = `${url}_${isSelf}_${thought}_${name}_${status}_${isGhost}`;\n        \n        if (iconCache.current.has(cacheKey)) {\n            return iconCache.current.get(cacheKey);\n        }\n\n        let className = 'avatar-marker';\n        // Ensure url is safely wrapped and background is configured\n        // Use double quotes for style attribute, single for url\n        let style = `background-image: url('${url}'); background-size: cover; background-position: center;`;\n\n        if (isSelf) {\n            className += ' self';\n            if (isGhost) {\n                style += ' opacity: 0.5; filter: grayscale(100%);';\n            }\n        }   \n        // Only show thought if it exists (simplified check)\n        // Add name display and include status if available\n        const thoughtHTML = thought\n            ? `<div class=\"thought-bubble\" style=\"background: white !important; color: black !important;\">\n                 <div class=\"thought-author\" style=\"color: #4285F4 !important; font-weight: 800;\">${name}</div>\n                 <div class=\"thought-content\" style=\"color: #000000 !important; font-weight: 600;\">\n                    ${thought}\n                 </div>\n               </div>`\n            : '';\n\n        const icon = L.divIcon({\n            className: 'custom-avatar-icon',\n            html: `\n                <div class=\"avatar-group\">\n                    ${thoughtHTML}\n                    <div class=\"${className}\" style=\"${style}\"></div>\n                </div>\n            `,\n            iconSize: [50, 50], // Increased to 50\n            iconAnchor: [25, 25],\n            popupAnchor: [0, -27]\n        });\n\n        iconCache.current.set(cacheKey, icon);\n        return icon;\n    };\n\n    // Memoize current user marker to avoid hook order issues\n    const currentUserMarker = useMemo(() => {\n        if (!currentUser || !userLocation) return null;\n\n        let avatarUrl;\n        if (currentUser.avatar_url) {\n            avatarUrl = getAvatar2D(currentUser.avatar_url);\n        } else {\n            // Strict Gender Fallback (No DiceBear)\n            if (currentUser.gender === 'Male') avatarUrl = DEFAULT_MALE_AVATAR;\n            else if (currentUser.gender === 'Female') avatarUrl = DEFAULT_FEMALE_AVATAR;\n            else avatarUrl = DEFAULT_GENERIC_AVATAR;\n        }\n\n        return (\n            <Marker\n                position={[userLocation.lat, userLocation.lng]}\n                icon={createAvatarIcon(avatarUrl, true, currentUser.thought, 'You')}\n                eventHandlers={{ click: () => setSelectedUser(null) }}\n            />\n        );\n    }, [currentUser, userLocation?.lat, userLocation?.lng]);\n\n // 4. Main App (Map & Overlays)\n    // visibleUsers filter was redundant with nearbyUsers logic. \n    // We use nearbyUsers directly which is already filtered to 300m and active users.\n\n    const filteredUsers = useMemo(() => {\n\n        if (!nearbyUsers || !currentUser) return [];\n\n        // ğŸŒ GLOBAL RULE (MOST IMPORTANT)\n        // ONLY users with LOCATION ON appear on map\n        const visibleUsers = nearbyUsers.filter(u =>\n            u.isLocationOn === true &&\n            u.lat != null &&\n            u.lng != null &&\n            u.isLocationShared !== false\n        );\n\n        const myLat = userLocation?.lat ?? currentUser?.latitude;\n        const myLng = userLocation?.lng ?? currentUser?.longitude;\n\n        switch (activeFilter) {\n\n        case \"Online\":\n            return visibleUsers.filter(u => {\n                if (!u.lastActive) return false;\n                const diff =\n                    Date.now() - new Date(u.lastActive).getTime();\n                return diff < 5 * 60 * 1000;\n            });\n\n        case \"Nearby\":\n            return visibleUsers.filter(u => {\n                if (!myLat || !myLng) return false;\n\n                const dist =\n                    getDistanceFromLatLonInKm(\n                        myLat,\n                        myLng,\n                        u.lat,\n                        u.lng\n                    ) * 1000;\n\n                return dist <= 300;\n            });\n\n        case \"Friends\":\n            return visibleUsers.filter(\n                u => u.friendshipStatus === \"accepted\"\n            );\n\n        case \"All\":\n        default:\n            return visibleUsers;\n    }\n\n}, [nearbyUsers, activeFilter, currentUser, userLocation]);\n\n\n    // Search Suggestions (derived from ALL users, ignoring current tab filter to find anyone)\n    const searchResults = useMemo(() => {\n        if (!searchQuery || searchQuery.trim().length === 0) return [];\n        const query = searchQuery.toLowerCase().trim();\n        // Search against ALL nearby users (or potentially all valid users if we had them)\n        // For now, nearbyUsers is our client-side cache of \"World\" around us.\n        return nearbyUsers.filter(u => u.name.toLowerCase().includes(query));\n    }, [nearbyUsers, searchQuery]);\n\n    const handleSearchResultClick = (user) => {\n        console.log(\"ğŸ” Search Result Selected:\", user.name);\n        setSearchQuery(''); // Clear search on select? Or keep it? Usually clear to show full map again?\n        // Requirement: \"Do not hide other avatars (unless a filter is active)\"\n        // So clearing search query restores the view.\n        setSelectedUser(user); // Triggers Zoom via UserSelectionController\n    };\n\n    // ------------------------------------------------------------------\n    // ğŸ“ MEMOIZED MARKERS (Clustered & Spiral)\n    // ------------------------------------------------------------------\n    const userMarkers = useMemo(() => {\n        // Process users to handle overlap (Spiderfy / Separation)\n        // Density-Based Clustering & Spiral Layout\n        \n        // 1. Sort for stability\n        const sortedUsers = [...filteredUsers].sort((a, b) => a.id.localeCompare(b.id));\n        const clusters = [];\n        // Threshold: ~330m covers marker size even at Zoom 15. Ensures 1m-apart users get spiraled.\n        const CLUSTER_THRESHOLD = 0.003; \n\n        // âœ… Add current user as a hidden anchor to force separation \n        // if anyone has the exact same coordinates (e.g. Realtime updates)\n        if (userLocation?.lat && userLocation?.lng) {\n            clusters.push([{ \n                lat: userLocation.lat, \n                lng: userLocation.lng, \n                isVirtualCenter: true \n            }]);\n        }\n\n        // 2. Cluster Users\n        sortedUsers.forEach(u => {\n            let placed = false;\n            for (let cluster of clusters) {\n                // Check distance to cluster center (using first user as anchor for stability)\n                const anchor = cluster[0];\n                if (Math.abs(u.lat - anchor.lat) < CLUSTER_THRESHOLD &&\n                    Math.abs(u.lng - anchor.lng) < CLUSTER_THRESHOLD) {\n                    cluster.push(u);\n                    placed = true;\n                    break;\n                }\n            }\n            if (!placed) clusters.push([u]);\n        });\n\n        // 3. Apply Spiral Layout\n        const processedUsers = [];\n        // Decreased from 0.0003 (~33m) to 0.00008 (~9m) to keep scattered avatars \n        // close enough to still clearly indicate they are at the \"same place\"\n        const SPIRAL_SPACING = 0.00008;\n        // Minimum radius so even the first user in a cluster doesn't sit at the exact center\n        // when there are multiple users (prevents z-index stacking hiding avatars)\n        const MIN_RADIUS = SPIRAL_SPACING;\n\n        clusters.forEach(cluster => {\n            const hasVirtual = cluster[0].isVirtualCenter;\n            const actualUsers = hasVirtual ? cluster.slice(1) : cluster;\n\n            if (actualUsers.length === 0) return; // Only virtual center, no one to spiral\n\n            if (actualUsers.length === 1 && !hasVirtual) {\n                processedUsers.push(actualUsers[0]);\n            } else {\n                // Calculate center of mass for the group (or just use anchor if virtual)\n                let avgLat = cluster[0].lat;\n                let avgLng = cluster[0].lng;\n                \n                if (!hasVirtual) {\n                    avgLat = cluster.reduce((sum, c) => sum + c.lat, 0) / cluster.length;\n                    avgLng = cluster.reduce((sum, c) => sum + c.lng, 0) / cluster.length;\n                }\n\n                actualUsers.forEach((u, i) => {\n                    // Archimedean Spiral / Golden Angle Packing\n                    // If virtual center exists, shift index up by 1 so we don't place someone dead center\n                    const indexOffset = hasVirtual ? i + 1 : i;\n                    const angle = indexOffset * 2.4; // ~137.5 degrees (golden angle)\n                    const radius = MIN_RADIUS + SPIRAL_SPACING * Math.sqrt(indexOffset + 1);\n\n                    processedUsers.push({\n                        ...u,\n                        lat: avgLat + (Math.cos(angle) * radius),\n                        lng: avgLng + (Math.sin(angle) * radius)\n                    });\n                });\n            }\n        });\n\n        return processedUsers.map(u => {\n            console.log(`ğŸ“ [MapHome] Rendering Marker for ${u.name}: [${u.lat}, ${u.lng}]`);\n            // Check thought expiration (3 hours)\n            let displayThought = u.thought;\n            if (u.status_updated_at) {\n                const diffHours = (new Date() - new Date(u.status_updated_at)) / (1000 * 60 * 60);\n                if (diffHours > 3) displayThought = null;\n            }\n\n            return (\n                <Marker\n                    key={u.id}\n                    position={[u.lat, u.lng]}\n                    icon={createAvatarIcon(getAvatar2D(u.avatar), false, displayThought, u.name, u.status)}\n                    riseOnHover={true}\n                    eventHandlers={{\n                        click: async () => {\n\n                            // Fetch friendship status synchronously to update UI instantly\n                            // Optimistically show card while loading if needed, but fetch runs fast.\n                            // We check if there's friendship where (me=req, them=rec) OR (me=rec, them=req)\n                            console.log(`ğŸ” [MapHome] Fetching friendship between Me(${currentUser?.id}) and ${u.name}(${u.id})`);\n                            \n                            // Prevent check if currentUser is null (edge case)\n                            if (!currentUser) {\n                                setSelectedUser(u);\n                                return;\n                            }\n\n                            const { data, error } = await supabase\n                                .from('friendships')\n                                .select('id, status, requester_id, receiver_id, muted_until_by_requester, muted_until_by_receiver')\n                                .or(`and(requester_id.eq.${currentUser.id},receiver_id.eq.${u.id}),and(requester_id.eq.${u.id},receiver_id.eq.${currentUser.id})`)\n                                .maybeSingle();\n\n                            if (error) console.error(\"âŒ [MapHome] Error fetching friendship:\", error);\n                            \n                            let isMuted = false;\n                            if (data) {\n                                let mutedUntil = null;\n                                if (data.requester_id === currentUser.id) mutedUntil = data.muted_until_by_requester;\n                                else if (data.receiver_id === currentUser.id) mutedUntil = data.muted_until_by_receiver;\n\n                                if (mutedUntil && new Date(mutedUntil) > new Date()) {\n                                    isMuted = true;\n                                }\n                            }\n\n                            setSelectedUser({\n                                ...u,\n                                // Robust Fallback: Use fetched data OR existing local data\n                                friendshipStatus: data?.status || u.friendshipStatus || null,\n                                friendshipId: data?.id || u.friendshipId || null,\n                                requesterId: data?.requester_id || null,\n                                receiverId: data?.receiver_id || null,\n                                isMuted: isMuted\n                            });\n                        }\n                    }}\n                />\n            );\n        });\n    }, [filteredUsers, currentUser]);\n\n    const ghostMode = currentUser?.is_ghost_mode === true;\n\n\n    // -------------------------------------------------\n    // ğŸ”„ SYNC LOCATION STATE\n    // -------------------------------------------------\n    // ğŸ”„ Sync\n    useEffect(() => {\n        if (locationEnabled && currentUser) {\n            if (currentUser.is_ghost_mode || currentUser.is_location_on === false) {\n                setCurrentUser(prev => {\n                    if (!prev) return prev;\n\n                    if (\n                        prev.is_ghost_mode === false &&\n                        prev.is_location_on === true\n                    ) {\n                        return prev; // prevent unnecessary re-render\n                    }\n\n                    return {\n                        ...prev,\n                        is_ghost_mode: false,\n                        is_location_on: true\n                    };\n                });\n            }\n        }\n    }, [\n        locationEnabled,\n        currentUser?.is_ghost_mode,\n        currentUser?.is_location_on\n    ]);\n\n\n    // 0ï¸âƒ£ Absolute Priority Overlay: Profile Setup (Must block everything, including GPS loading and permissions)\n    if (showProfileSetup) {\n        return (\n            <div className=\"map-container\" style={{ position: 'fixed', top: 0, left: 0, width: '100%', height: '100dvh' }}>\n                <style>{`\n                    .onboarding-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; z-index: 999999; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif; }\n                    .onboarding-card { background: #18181b; border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; padding: 32px 24px; width: 100%; max-width: 380px; box-shadow: 0 24px 48px rgba(0, 0, 0, 0.6); color: white; display: flex; flex-direction: column; gap: 20px; }\n                    .onboarding-card h2 { margin: 0; font-size: 1.6rem; color: #fff; text-align: left; }\n                    .onboarding-card h2 span.wave { color: #00a8ff; }\n                    .onboarding-card p { margin: 0; font-size: 0.95rem; color: #a1a1aa; text-align: left; margin-top: -12px; }\n                    .ob-section { display: flex; flex-direction: column; gap: 12px; text-align: left; }\n                    .ob-section label { font-size: 0.9rem; font-weight: 600; color: #fff; }\n                    .ob-input { background: #27272a; border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 14px 16px; color: white; font-size: 1rem; outline: none; transition: all 0.2s; width: 100%; box-sizing: border-box; }\n                    .ob-input:focus { border-color: #0084ff; background: #2f2f33; }\n                    .chip-group { display: flex; flex-wrap: wrap; gap: 10px; }\n                    .chip { background: transparent; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 20px; padding: 8px 18px; color: #a1a1aa; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }\n                    .chip:hover { background: rgba(255, 255, 255, 0.05); }\n                    .chip.selected { background: transparent; border-color: rgba(255, 255, 255, 0.3); color: white; }\n                    .complete-btn { background: #0084ff; color: white; border: none; border-radius: 14px; padding: 16px; font-size: 1.05rem; font-weight: 600; cursor: pointer; margin-top: 10px; transition: background 0.2s, transform 0.1s; }\n                    .complete-btn:hover { background: #0073e6; }\n                    .complete-btn:active { transform: scale(0.98); }\n                `}</style>\n                <div className=\"onboarding-overlay\">\n                    <div className=\"onboarding-card\">\n                        <h2>Welcome to SocialMap! ğŸ‘‹</h2>\n                        <p>Complete your profile to join.</p>\n\n                        <div className=\"ob-section\">\n                            <label>Username</label>\n                            <input\n                                type=\"text\"\n                                className=\"ob-input\"\n                                value={setupData.username}\n                                onChange={(e) => setSetupData({ ...setupData, username: e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, '') })}\n                                placeholder=\"Choose a username\"\n                            />\n                        </div>\n\n                        <div className=\"ob-section\">\n                            <label>Gender</label>\n                            <div className=\"chip-group\">\n                                {['Male', 'Female', 'Non-binary', 'Other'].map(g => (\n                                    <button\n                                        key={g}\n                                        className={`chip ${setupData.gender === g ? 'selected' : ''}`}\n                                        onClick={() => setSetupData({ ...setupData, gender: g })}\n                                    >{g}</button>\n                                ))}\n                            </div>\n                        </div>\n\n                        <div className=\"ob-section\">\n                            <label>Relationship Status</label>\n                            <div className=\"chip-group\">\n                                {['Single', 'Married', 'Committed', 'Open to Date'].map(s => (\n                                    <button\n                                        key={s}\n                                        className={`chip ${setupData.relationshipStatus === s ? 'selected' : ''}`}\n                                        onClick={() => setSetupData({ ...setupData, relationshipStatus: s })}\n                                    >{s}</button>\n                                ))}\n                            </div>\n                        </div>\n\n                        <div className=\"ob-section\">\n                            <label>Your Avatar ğŸ‘¤</label>\n                            <div className=\"avatar-preview-box\" style={{ position: 'relative', width: '100px', margin: '0 auto' }}>\n                                <div style={{\n                                    width: '100px', height: '100px',\n                                    borderRadius: '50%', overflow: 'hidden',\n                                    border: '3px solid rgba(255,255,255,0.2)',\n                                    background: 'rgba(255,255,255,0.05)',\n                                    display: 'flex', alignItems: 'center', justifyContent: 'center'\n                                }}>\n                                    <img\n                                        src={(() => {\n                                            // Priority 1: Uploaded Preview\n                                            if (avatarPreview) return avatarPreview;\n\n                                            // Priority 2: Gender Default\n                                            const g = setupData.gender;\n                                            if (g === 'Male') return DEFAULT_MALE_AVATAR;\n                                            if (g === 'Female') return DEFAULT_FEMALE_AVATAR;\n\n                                            // Fallback\n                                            return DEFAULT_GENERIC_AVATAR;\n                                        })()}\n                                        alt=\"Avatar Preview\"\n                                        style={{ width: '100%', height: '100%', objectFit: 'cover' }}\n                                    />\n                                </div>\n\n                                {/* Upload Button Overlay */}\n                                <label\n                                    htmlFor=\"modal-avatar-upload\"\n                                    style={{\n                                        position: 'absolute', bottom: '0', right: '0',\n                                        width: '32px', height: '32px',\n                                        background: 'var(--brand-blue, #0084ff)',\n                                        borderRadius: '50%',\n                                        display: 'flex', alignItems: 'center', justifyContent: 'center',\n                                        cursor: 'pointer',\n                                        boxShadow: '0 4px 10px rgba(0,0,0,0.3)',\n                                        border: '2px solid #1c1c1e',\n                                        zIndex: 10\n                                    }}\n                                >\n                                    <span style={{ fontSize: '1.2rem', color: 'white', marginTop: '-2px' }}>+</span>\n                                </label>\n                                <input\n                                    id=\"modal-avatar-upload\"\n                                    type=\"file\"\n                                    accept=\"image/*\"\n                                    onChange={(e) => {\n                                        const file = e.target.files[0];\n                                        if (file) {\n                                            const reader = new FileReader();\n                                            reader.onload = () => setCropImage(reader.result);\n                                            reader.readAsDataURL(file);\n                                            e.target.value = '';\n                                        }\n                                    }}\n                                    style={{ display: 'none' }}\n                                />\n                            </div>\n                            <p className=\"avatar-hint\" style={{ marginTop: '12px', textAlign: 'center', color: '#a1a1aa' }}>\n                                {avatarFile ? 'Photo selected! Ready to join.' : \"We've assigned you a look based on gender. Tap + to upload your own!\"}\n                            </p>\n                        </div>\n\n                        <button className=\"complete-btn\" onClick={handleCompleteSetup}>\n                            Complete Setup & Enter Map ğŸš€\n                        </button>\n                    </div>\n                </div>\n\n                {/* Cropper Modal for Onboarding */}\n                {cropImage && (\n                    <ImageCropper\n                        imageSrc={cropImage}\n                        zIndex={10000000}\n                        onCancel={() => setCropImage(null)}\n                        onCropComplete={(croppedBlob) => {\n                            const file = new File([croppedBlob], `avatar_${Date.now()}.jpg`, { type: 'image/jpeg' });\n                            setAvatarFile(file);\n                            setAvatarPreview(URL.createObjectURL(file));\n                            setCropImage(null);\n                        }}\n                    />\n                )}\n            </div>\n        );\n    }\n\n    // 1ï¸âƒ£ Loading\n    if (loadingLocation) {\n        return (\n            <div style={{\n                height:\"100dvh\", display:\"flex\", flexDirection:\"column\",\n                justifyContent:\"center\", alignItems:\"center\",\n                background: isDarkMode ? \"#111113\" : \"#fafafa\",\n                gap:\"18px\"\n            }}>\n                <style>{`\n                    @keyframes loc-spin {\n                        0% { transform: rotate(0deg); }\n                        100% { transform: rotate(360deg); }\n                    }\n                    @keyframes loc-fade { 0%,100%{opacity:.3} 50%{opacity:1} }\n                `}</style>\n                <div style={{ position:\"relative\", width:\"56px\", height:\"56px\" }}>\n                    <div style={{\n                        position:\"absolute\", inset:0, borderRadius:\"50%\",\n                        border: isDarkMode ? \"2px solid rgba(255,255,255,.08)\" : \"2px solid rgba(0,0,0,.06)\"\n                    }}/>\n                    <div style={{\n                        position:\"absolute\", inset:0, borderRadius:\"50%\",\n                        border:\"2px solid transparent\",\n                        borderTopColor: isDarkMode ? \"rgba(255,255,255,.6)\" : \"#6c47ff\",\n                        animation:\"loc-spin 0.9s linear infinite\"\n                    }}/>\n                    <div style={{\n                        position:\"absolute\", inset:\"14px\", borderRadius:\"50%\",\n                        background: isDarkMode ? \"rgba(255,255,255,.06)\" : \"rgba(108,71,255,.08)\",\n                        display:\"flex\", alignItems:\"center\", justifyContent:\"center\",\n                        fontSize:\"16px\"\n                    }}>ğŸ“</div>\n                </div>\n                <p style={{\n                    color: isDarkMode ? \"rgba(255,255,255,.45)\" : \"rgba(0,0,0,.4)\",\n                    fontSize:\"14px\", margin:0, letterSpacing:\"0.3px\"\n                }}>Finding your locationâ€¦</p>\n            </div>\n        );\n    }\n\n    // 2ï¸âƒ£ Location disabled â€” permission screen\n    if (!locationEnabled) {\n        const dark = isDarkMode;\n        return (\n            <div style={{\n                height:\"100dvh\", display:\"flex\", flexDirection:\"column\",\n                justifyContent:\"center\", alignItems:\"center\",\n                background: dark ? \"#111113\" : \"#fafafa\",\n                padding:\"32px\", textAlign:\"center\"\n            }}>\n                <style>{`\n                    @keyframes loc-float {\n                        0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)}\n                    }\n                `}</style>\n\n                {/* Floating map pin icon */}\n                <div style={{\n                    width:\"88px\", height:\"88px\", borderRadius:\"28px\",\n                    background: dark\n                        ? \"linear-gradient(145deg,#1e1e24,#2a2a35)\"\n                        : \"linear-gradient(145deg,#ffffff,#f0eeff)\",\n                    boxShadow: dark\n                        ? \"0 20px 60px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.06)\"\n                        : \"0 20px 60px rgba(108,71,255,.15), inset 0 1px 0 rgba(255,255,255,.9)\",\n                    display:\"flex\", alignItems:\"center\", justifyContent:\"center\",\n                    fontSize:\"40px\", marginBottom:\"32px\",\n                    animation:\"loc-float 3s ease-in-out infinite\"\n                }}>ğŸ“</div>\n\n                {/* Heading */}\n                <h2 style={{\n                    margin:\"0 0 10px\", fontSize:\"24px\", fontWeight:700,\n                    color: dark ? \"#f0f0f0\" : \"#1a1a2e\",\n                    letterSpacing:\"-0.5px\"\n                }}>Share Your Location</h2>\n\n                {/* Subtext */}\n                <p style={{\n                    margin:\"0 0 32px\", fontSize:\"14px\", lineHeight:1.7,\n                    color: dark ? \"rgba(255,255,255,.45)\" : \"rgba(0,0,0,.45)\",\n                    maxWidth:\"270px\"\n                }}>\n                    See who's around you in real time. Your location is only visible while you're active.\n                </p>\n\n                {/* Feature pills â€” compact horizontal */}\n                <div style={{ display:\"flex\", gap:\"8px\", marginBottom:\"32px\", flexWrap:\"wrap\", justifyContent:\"center\" }}>\n                    {[\n                        [\"ğŸ‘¥\", \"Nearby people\"],\n                        [\"ğŸ”’\", \"Private\"],\n                        [\"âš¡\", \"Real-time\"]\n                    ].map(([icon, label]) => (\n                        <div key={label} style={{\n                            display:\"flex\", alignItems:\"center\", gap:\"5px\",\n                            padding:\"5px 11px\", borderRadius:\"20px\",\n                            background: dark ? \"rgba(255,255,255,.06)\" : \"rgba(0,0,0,.05)\",\n                            border: dark ? \"1px solid rgba(255,255,255,.08)\" : \"1px solid rgba(0,0,0,.07)\",\n                        }}>\n                            <span style={{ fontSize:\"13px\" }}>{icon}</span>\n                            <span style={{ fontSize:\"12px\", fontWeight:500, color: dark ? \"rgba(255,255,255,.6)\" : \"rgba(0,0,0,.55)\" }}>{label}</span>\n                        </div>\n                    ))}\n                </div>\n\n                {/* CTA Button */}\n                <button\n                    onClick={startLocation}\n                    style={{\n                        width:\"100%\", maxWidth:\"260px\",\n                        padding:\"15px 0\", borderRadius:\"16px\", border:\"none\",\n                        background: dark\n                            ? \"linear-gradient(135deg,#7c5cfc,#5b3fd4)\"\n                            : \"linear-gradient(135deg,#6c47ff,#4f2fe8)\",\n                        color:\"white\", fontWeight:700, fontSize:\"16px\",\n                        cursor:\"pointer\", letterSpacing:\"0.2px\",\n                        boxShadow: \"0 8px 32px rgba(108,71,255,.35)\",\n                        transition:\"transform 0.15s, box-shadow 0.15s\"\n                    }}\n                    onMouseDown={e => { e.currentTarget.style.transform=\"scale(0.97)\"; e.currentTarget.style.boxShadow=\"0 4px 16px rgba(108,71,255,.25)\"; }}\n                    onMouseUp={e => { e.currentTarget.style.transform=\"scale(1)\"; e.currentTarget.style.boxShadow=\"0 8px 32px rgba(108,71,255,.35)\"; }}\n                    onTouchStart={e => { e.currentTarget.style.transform=\"scale(0.97)\"; }}\n                    onTouchEnd={e => { e.currentTarget.style.transform=\"scale(1)\"; }}\n                >\n                    Enable Location\n                </button>\n\n                <p style={{\n                    marginTop:\"14px\", fontSize:\"12px\",\n                    color: dark ? \"rgba(255,255,255,.2)\" : \"rgba(0,0,0,.25)\"\n                }}>You can disable this anytime</p>\n            </div>\n        );\n    }\n\n\n\n    // 4ï¸âƒ£ Waiting for GPS fix\n    if (!userLocation) {\n        return (\n            <div style={{\n                height:\"100dvh\", display:\"flex\", flexDirection:\"column\",\n                justifyContent:\"center\", alignItems:\"center\",\n                background: isDarkMode ? \"#111113\" : \"#fafafa\",\n                gap:\"18px\"\n            }}>\n                <style>{`\n                    @keyframes loc-spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }\n                `}</style>\n                <div style={{ position:\"relative\", width:\"56px\", height:\"56px\" }}>\n                    <div style={{\n                        position:\"absolute\", inset:0, borderRadius:\"50%\",\n                        border: isDarkMode ? \"2px solid rgba(255,255,255,.08)\" : \"2px solid rgba(0,0,0,.06)\"\n                    }}/>\n                    <div style={{\n                        position:\"absolute\", inset:0, borderRadius:\"50%\",\n                        border:\"2px solid transparent\",\n                        borderTopColor: isDarkMode ? \"rgba(255,255,255,.6)\" : \"#6c47ff\",\n                        animation:\"loc-spin 0.9s linear infinite\"\n                    }}/>\n                    <div style={{\n                        position:\"absolute\", inset:\"14px\", borderRadius:\"50%\",\n                        background: isDarkMode ? \"rgba(255,255,255,.06)\" : \"rgba(108,71,255,.08)\",\n                        display:\"flex\", alignItems:\"center\", justifyContent:\"center\",\n                        fontSize:\"16px\"\n                    }}>ğŸ“¡</div>\n                </div>\n                <p style={{\n                    color: isDarkMode ? \"rgba(255,255,255,.45)\" : \"rgba(0,0,0,.4)\",\n                    fontSize:\"14px\", margin:0, letterSpacing:\"0.3px\"\n                }}>Getting your precise locationâ€¦</p>\n            </div>\n        );\n    }\n\n\n\n    // 5ï¸âƒ£ If all good, render map\n    return (\n        <div className=\"map-container\" style={{ \n            position: 'fixed', \n            top: 0, \n            left: 0, \n            width: '100%', \n            height: '100dvh', \n            overflow: 'hidden',\n            overscrollBehavior: 'none' \n        }}>\n            <style>{`\n                .onboarding-overlay {\n                    position: fixed;\n                    inset: 0;\n                    background: rgba(0, 0, 0, 0.7);\n                    backdrop-filter: blur(12px);\n                    -webkit-backdrop-filter: blur(12px);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    z-index: 999999;\n                    padding: 20px;\n                    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif;\n                }\n                .onboarding-card {\n                    background: #18181b;\n                    border: 1px solid rgba(255, 255, 255, 0.08);\n                    border-radius: 24px;\n                    padding: 32px 24px;\n                    width: 100%;\n                    max-width: 380px;\n                    box-shadow: 0 24px 48px rgba(0, 0, 0, 0.6);\n                    color: white;\n                    display: flex;\n                    flex-direction: column;\n                    gap: 20px;\n                }\n                .onboarding-card h2 {\n                    margin: 0;\n                    font-size: 1.6rem;\n                    color: #fff;\n                    text-align: left;\n                }\n                .onboarding-card h2 span.wave {\n                    color: #00a8ff;\n                }\n                .onboarding-card p {\n                    margin: 0;\n                    font-size: 0.95rem;\n                    color: #a1a1aa;\n                    text-align: left;\n                    margin-top: -12px;\n                }\n                .ob-section {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 12px;\n                }\n                .ob-section label {\n                    font-size: 0.9rem;\n                    font-weight: 600;\n                    color: #fff;\n                }\n                .ob-input {\n                    background: #27272a;\n                    border: 1px solid rgba(255, 255, 255, 0.08);\n                    border-radius: 12px;\n                    padding: 14px 16px;\n                    color: white;\n                    font-size: 1rem;\n                    outline: none;\n                    transition: all 0.2s;\n                }\n                .ob-input:focus {\n                    border-color: #0084ff;\n                    background: #2f2f33;\n                }\n                .chip-group {\n                    display: flex;\n                    flex-wrap: wrap;\n                    gap: 10px;\n                }\n                .chip {\n                    background: transparent;\n                    border: 1px solid rgba(255, 255, 255, 0.15);\n                    border-radius: 20px;\n                    padding: 8px 18px;\n                    color: #a1a1aa;\n                    font-size: 0.9rem;\n                    cursor: pointer;\n                    transition: all 0.2s;\n                }\n                .chip:hover {\n                    background: rgba(255, 255, 255, 0.05);\n                }\n                .chip.selected {\n                    background: transparent;\n                    border-color: rgba(255, 255, 255, 0.3);\n                    color: white;\n                }\n                .complete-btn {\n                    background: #0084ff;\n                    color: white;\n                    border: none;\n                    border-radius: 14px;\n                    padding: 16px;\n                    font-size: 1.05rem;\n                    font-weight: 600;\n                    cursor: pointer;\n                    margin-top: 10px;\n                    transition: background 0.2s, transform 0.1s;\n                }\n                .complete-btn:hover {\n                    background: #0073e6;\n                }\n                .complete-btn:active {\n                    transform: scale(0.98);\n                }\n            `}</style>\n            {/* PROFILE UPDATE NUDGE */}\n            {currentUser && (\n                (!currentUser.avatar_url ||\n                    currentUser.avatar_url.includes('/defaults/') ||\n                    currentUser.avatar_url.includes('dicebear') ||\n                    currentUser.avatar_url.includes('googleusercontent'))\n            ) && (\n                    <div\n                        className=\"update-nudge\"\n                        onClick={() => navigate('/profile')}\n                    >\n                        âš ï¸ Update profile avatar\n                    </div>\n                )}\n\n\n\n            {/* PROFILE UPDATE NUDGE */}\n            {currentUser && (\n                (!currentUser.avatar_url ||\n                    currentUser.avatar_url.includes('/defaults/') ||\n                    currentUser.avatar_url.includes('dicebear') ||\n                    currentUser.avatar_url.includes('googleusercontent'))\n            ) && (\n                    <div\n                        className=\"update-nudge\"\n                        onClick={() => navigate('/profile')}\n                    >\n                        âš ï¸ Update profile avatar\n                    </div>\n                )}\n\n            {/* Cropper Modal */}\n            {cropImage && (\n                <ImageCropper\n                    imageSrc={cropImage}\n                    zIndex={10000000}\n                    onCancel={() => setCropImage(null)}\n                    onCropComplete={(croppedBlob) => {\n                        const file = new File([croppedBlob], `avatar_${Date.now()}.jpg`, { type: 'image/jpeg' });\n                        setAvatarFile(file);\n                        setAvatarPreview(URL.createObjectURL(file));\n                        setCropImage(null);\n                    }}\n                />\n            )}\n\n            {/* Map Container */}\n            <MapContainer\n                key=\"map-main-stable\"\n                center={[userLocation.lat, userLocation.lng]}\n                zoom={17}\n                maxZoom={22}\n                style={{ height: '100dvh', width: '100%', outline: 'none' }} \n                zoomControl={false}\n                attributionControl={false}\n                scrollWheelZoom={true} // ğŸ”¥ Re-enabled per user request\n                doubleClickZoom={true}\n                dragging={true}\n                zoomAnimation={true}\n            >\n                {/* Map Layers based on State */}\n                {mapMode === 'street' && (\n                    <TileLayer\n                        attribution='&copy; Google Maps'\n                        url=\"https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}\"\n                        className={isDarkMode ? 'dark-map-tiles' : ''}\n                        maxNativeZoom={20}\n                        maxZoom={22}\n                        keepBuffer={4}\n                    />\n                )}\n                {mapMode === 'hybrid' && (\n                    <TileLayer\n                        attribution='&copy; Google Maps'\n                        url=\"https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}\"\n                        maxNativeZoom={20}\n                        maxZoom={22}\n                        keepBuffer={4}\n                    />\n                )}\n                {mapMode === 'satellite' && (\n                    <TileLayer\n                        attribution='&copy; Google Maps'\n                        url=\"https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}\"\n                        maxNativeZoom={20}\n                        maxZoom={22}\n                        keepBuffer={4}\n                    />\n                )}\n              {/* 3ï¸âƒ£ Controls & Logic */}\n            <RecenterAutomatically \n                lat={userLocation.lat} \n                lng={userLocation.lng} \n                mapMode={mapMode} // ğŸ”¥ Passing mode to trigger recenter\n            />\n                <RecenterControl lat={userLocation.lat} lng={userLocation.lng} />\n                <UserSelectionController selectedUser={selectedUser} />\n\n                <Circle\n                    center={[userLocation.lat, userLocation.lng]}\n                    radius={300}\n                    pathOptions={{\n                        color: '#4285F4',\n                        fillColor: '#4285F4',\n                        fillOpacity: 0.1,\n                        weight: 1,\n                        dashArray: '5, 10'\n                    }}\n                />\n\n                {/* Current User Marker (Memoized above) */}\n                {currentUserMarker}\n\n                {/* Memoized User Markers */}\n                {userMarkers}\n            </MapContainer>\n\n\n            {/* Top Search Bar & Action Buttons */}\n            <div className=\"map-header-controls\">\n                <div className=\"header-top-row\">\n                    <div className=\"search-bar-container glass-panel\">\n                        <svg width=\"15\" height=\"15\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2.2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" style={{ opacity:0.4, flexShrink:0 }}>\n                            <circle cx=\"11\" cy=\"11\" r=\"8\"/><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/>\n                        </svg>\n                        <input \n                            type=\"text\" \n                            placeholder=\"Find people...\" \n                            value={searchQuery}\n                            onChange={(e) => setSearchQuery(e.target.value)}\n                        />\n                        {/* Search Dropdown */}\n                        {searchQuery && searchResults.length > 0 && (\n                            <div className=\"search-results-dropdown\">\n                                {searchResults.map(user => (\n                                    <div \n                                        key={user.id} \n                                        className=\"search-result-item\"\n                                        onClick={() => handleSearchResultClick(user)}\n                                    >\n                                        <img src={getAvatar2D(user.avatar)} alt={user.name} className=\"search-result-avatar\" />\n                                        <span>{user.name}</span>\n                                    </div>\n                                ))}\n                            </div>\n                        )}\n                    </div>\n                    \n                    {/* Action Buttons - Right Side */}\n                    <div className=\"header-action-buttons\">\n                        {/* Status / Thoughts */}\n                        <button \n                            className=\"control-btn\" \n                            style={{ background: 'var(--bg-primary, #ffffff)', boxShadow: '0 2px 8px rgba(0,0,0,0.15)' }}\n                            onClick={() => setShowThoughtInput(true)} \n                            title=\"Set Status\"\n                        >\n                            <svg width=\"17\" height=\"17\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" style={{ opacity:0.65 }}>\n                                <path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"/>\n                            </svg>\n                        </button>\n                        \n                        {/* Ghost Mode Toggle */}\n                        <button\n                            className={`control-btn ${currentUser?.is_ghost_mode ? 'active' : ''}`}\n                            style={{ background: 'var(--bg-primary, #ffffff)', boxShadow: '0 2px 8px rgba(0,0,0,0.15)' }}\n                            onClick={() => {\n                                if (currentUser?.is_ghost_mode) {\n                                    // Hidden â†’ Visible\n                                    startLocation();\n                                    showToast(\"ğŸ‘ï¸ Ghost Mode OFF (Visible)\");\n                                } else {\n                                    // Visible â†’ Hidden\n                                    stopLocation();\n                                    showToast(\"ğŸ‘» Ghost Mode ON (Hidden)\");\n                                }\n                            }}\n\n                            title=\"Toggle Ghost Mode\"\n                        >\n                            {currentUser?.is_ghost_mode ? (\n                                /* Ghost/Hidden icon */\n                                <svg width=\"17\" height=\"17\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#6c47ff\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                                    <path d=\"M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24\"/>\n                                    <line x1=\"1\" y1=\"1\" x2=\"23\" y2=\"23\"/>\n                                </svg>\n                            ) : (\n                                /* Eye/Visible icon */\n                                <svg width=\"17\" height=\"17\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" style={{ opacity:0.65 }}>\n                                    <path d=\"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z\"/>\n                                    <circle cx=\"12\" cy=\"12\" r=\"3\"/>\n                                </svg>\n                            )}\n                        </button>\n\n                        {/* Map View Toggle */}\n                        <button \n                            className=\"control-btn\"\n                            onClick={() => {\n                                const modes = ['street', 'satellite', 'hybrid'];\n                                const nextIndex = (modes.indexOf(mapMode) + 1) % modes.length;\n                                setMapMode(modes[nextIndex]);\n                            }}\n                            title=\"Toggle Map View\"\n                            style={{ \n                                background: 'var(--bg-primary, #ffffff)',\n                                boxShadow: '0 2px 8px rgba(0,0,0,0.15)',\n                                marginLeft: '6px', \n                                padding: '0', \n                                width: '36px',\n                                height: '36px',\n                                borderRadius: '50%',\n                                display: 'flex',\n                                alignItems: 'center',\n                                justifyContent: 'center',\n                                flexShrink: 0, \n                                aspectRatio: '1/1'\n                            }}\n                        >\n                             <svg width=\"17\" height=\"17\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" style={{ opacity:0.65 }}>\n                                <polygon points=\"12 2 2 7 12 12 22 7 12 2\"/>\n                                <polyline points=\"2 17 12 22 22 17\"/>\n                                <polyline points=\"2 12 12 17 22 12\"/>\n                            </svg>\n                        </button>\n                    </div>\n                </div>\n                \n                {/* Horizontal Filter Scroll */}\n                <div className=\"filter-scroll\">\n                    {FILTERS.map(f => (\n                        <button \n                            key={f}\n                            className={`filter-chip glass-pill ${activeFilter === f ? 'active' : ''}`}\n                            onClick={() => setActiveFilter(f)}\n                        >\n                            {f}\n                        </button>\n                    ))}\n                    \n                    {/* Map View Toggle Moved to Header Actions */}\n                </div>\n            </div>\n\n\n            {/* Bottom Navigation */}\n            <BottomNav \n                friendRequestCount={friendRequests.length} \n                unreadMessageCount={unreadCount} \n            />\n\n            <style>{`\n                .map-header-controls {\n                    position: absolute;\n                    top: 0; /* Use padding for safe area instead of top */\n                    padding-top: max(16px, env(safe-area-inset-top));\n                    left: 0; right: 0;\n                    z-index: 1000;\n                    padding-left: 16px; \n                    padding-right: 16px;\n                    display: flex;\n                    flex-direction: column;\n                    gap: 8px;\n                    pointer-events: none;\n                }\n\n                .header-top-row {\n                    display: flex;\n                    align-items: center;\n                    gap: 8px;\n                    pointer-events: auto;\n                }\n\n                .search-bar-container {\n                    flex: 1;\n                    display: flex;\n                    align-items: center;\n                    padding: 6px 12px;\n                    border-radius: 16px;\n                    gap: 8px;\n                    transition: all 0.3s ease;\n                    max-width: 400px;\n                }\n\n                .header-action-buttons {\n                    display: flex;\n                    gap: 6px;\n                }\n\n                .search-bar-container:focus-within {\n                    transform: scale(1.02);\n                    box-shadow: 0 8px 30px rgba(0,0,0,0.15);\n                }\n\n                .search-icon { font-size: 1.2rem; opacity: 0.6; }\n\n                .search-bar-container input {\n                    border: none;\n                    background: transparent;\n                    font-size: 13px;\n                    width: 100%;\n                    color: inherit;\n                    outline: none;\n                }\n\n                .filter-scroll {\n                    pointer-events: auto;\n                    display: flex;\n                    gap: 10px;\n                    overflow-x: auto;\n                    padding-bottom: 4px;\n                    -webkit-overflow-scrolling: touch;\n                    scrollbar-width: none; /* Firefox */\n                }\n                .filter-scroll::-webkit-scrollbar { display: none; }\n\n                .filter-chip {\n                    padding: 6px 12px;\n                    white-space: nowrap;\n                    font-size: 12px;\n                    font-weight: 500;\n                    color: inherit;\n                    cursor: pointer;\n                    transition: all 0.2s;\n                }\n\n                .filter-chip.active {\n                    background: #6c47ff;\n                    color: white;\n                    border-color: #6c47ff;\n                }\n\n                .search-results-dropdown {\n                    position: absolute;\n                    top: 100%;\n                    left: 0;\n                    right: 0;\n                    background: rgba(255, 255, 255, 0.95);\n                    backdrop-filter: blur(12px);\n                    border-radius: 12px;\n                    margin-top: 8px;\n                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);\n                    overflow: hidden;\n                    max-height: 200px;\n                    overflow-y: auto;\n                    z-index: 2000;\n                }\n                .search-result-item {\n                    padding: 10px 16px;\n                    display: flex;\n                    align-items: center;\n                    gap: 10px;\n                    cursor: pointer;\n                    transition: background 0.2s;\n                    color: #000;\n                }\n                .search-result-item:hover {\n                    background: rgba(0,0,0,0.05);\n                }\n                .search-result-avatar {\n                    width: 32px; height: 32px;\n                    border-radius: 50%;\n                    object-fit: cover;\n                }\n                \n                @media (prefers-color-scheme: dark) {\n                    .search-results-dropdown {\n                        background: rgba(28, 28, 30, 0.95);\n                        color: white !important;\n                    }\n                    .search-result-item {\n                        color: white !important;\n                    }\n                    .search-result-item:hover {\n                        background: rgba(255,255,255,0.1);\n                    }\n                }\n\n\n\n            `}</style>\n\n            <MapProfileCard\n                user={selectedUser}\n                currentUser={currentUser}\n                onClose={() => setSelectedUser(null)}\n                onAction={handleUserAction}\n            />\n\n            {showFullProfile && fullProfileUser && (\n                <FullProfileModal\n                    user={fullProfileUser}\n                    currentUser={currentUser}\n                    onClose={() => setShowFullProfile(false)}\n                    onAction={handleUserAction}\n                />\n            )}\n\n\n            <PokeNotifications currentUser={currentUser} />\n            {toastMsg && <Toast message={toastMsg} onClose={() => setToastMsg(null)} />}\n\n            {/* Report Modal */}\n            {showReportModal && reportTarget && (\n                <div className=\"report-modal-overlay\" onClick={() => setShowReportModal(false)}>\n                    <div className=\"report-modal-card\" onClick={e => e.stopPropagation()}>\n                        {/* Warning Icon Header */}\n                        <div className=\"report-icon-header\">\n                            <svg width=\"48\" height=\"48\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\">\n                                <path d=\"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z\"></path>\n                                <line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\"></line>\n                                <line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"></line>\n                            </svg>\n                        </div>\n\n                        <h3>Report {reportTarget.name}</h3>\n                        <p>Please select a reason for reporting:</p>\n\n                        <div className=\"report-reasons\">\n                            <button onClick={() => handleReport('Fake or Misleading Profile')}>\n                                <span className=\"report-emoji\">ğŸ­</span>\n                                <span>Fake or Misleading Profile</span>\n                            </button>\n                            <button onClick={() => handleReport('Harassment or Misbehavior')}>\n                                <span className=\"report-emoji\">ğŸ˜¡</span>\n                                <span>Harassment or Misbehavior</span>\n                            </button>\n                            <button onClick={() => handleReport('Location Misuse')}>\n                                <span className=\"report-emoji\">ğŸ“</span>\n                                <span>Location Misuse</span>\n                            </button>\n                            <button onClick={() => handleReport('Underage or Safety Concern')}>\n                                <span className=\"report-emoji\">ğŸ”</span>\n                                <span>Underage or Safety Concern</span>\n                            </button>\n                            <button onClick={() => handleReport('Other')}>\n                                <span className=\"report-emoji\">â“</span>\n                                <span>Other</span>\n                            </button>\n                        </div>\n\n                        <button className=\"cancel-report-btn\" onClick={() => setShowReportModal(false)}>\n                            Cancel\n                        </button>\n                    </div>\n                </div>\n            )}\n\n            {/* Mute Duration Modal */}\n            {showMuteModal && muteTarget && (\n                <div className=\"report-modal-overlay\" onClick={() => setShowMuteModal(false)}>\n                    <div className=\"report-modal-card\" onClick={e => e.stopPropagation()}>\n                        <h3>ğŸ”• Mute {muteTarget.name}</h3>\n                        <p>Mute notifications for:</p>\n                        <div className=\"report-reasons\">\n                            {[\n                                { label: '10 Minutes', val: 10 },\n                                { label: '30 Minutes', val: 30 },\n                                { label: '1 Hour', val: 60 },\n                                { label: '24 Hours', val: 1440 }\n                            ].map(opt => (\n                                <button key={opt.val} onClick={async () => {\n                                    try {\n                                        const mins = opt.val;\n                                        const future = new Date(new Date().getTime() + mins * 60000);\n                                        const isRequester = muteTarget.requesterId === currentUser.id;\n                                        const column = isRequester ? 'muted_until_by_requester' : 'muted_until_by_receiver';\n\n                                        await supabase\n                                            .from('friendships')\n                                            .update({ [column]: future.toISOString() })\n                                            .eq('id', muteTarget.friendshipId);\n\n                                        showToast(`Muted ${muteTarget.name} for ${opt.label} ğŸ”•`);\n                                        setShowMuteModal(false);\n                                        // Update local state if this user is still selected\n                                        if (selectedUser?.id === muteTarget.id) {\n                                            setSelectedUser(prev => ({ ...prev, isMuted: true }));\n                                        }\n                                        setMuteTarget(null);\n                                    } catch (err) {\n                                        console.error(\"Timed mute error\", err);\n                                        showToast(\"Failed to mute\");\n                                    }\n                                }}>\n                                    â³ {opt.label}\n                                </button>\n                            ))}\n                        </div>\n                        <button className=\"cancel-report-btn\" onClick={() => setShowMuteModal(false)}>\n                            Cancel\n                        </button>\n                    </div>\n                </div>\n            )}\n\n            {/* Story Viewer Overlay */}\n            {viewingStoryUser && (\n                <StoryViewer\n                    userStories={viewingStoryUser}\n                    currentUser={currentUser}\n                    onClose={() => {\n                        const viewedUserId = viewingStoryUser.user.id;\n                        setViewingStoryUser(null);\n\n                        // Optimistically mark as seen for map ring\n                        setNearbyUsers(prev => prev.map(u =>\n                            u.id === viewedUserId\n                                ? { ...u, hasUnseenStory: false }\n                                : u\n                        ));\n\n                        // Also update the global set to prevent it from reappearing on next fetch\n                        // (Though fetches usually refresh this based on DB)\n                    }}\n                />\n            )}\n\n            <style>{`\n                .report-modal-overlay {\n                    position: fixed;\n                    top: 0; left: 0; right: 0; bottom: 0;\n                    background: rgba(0, 0, 0, 0.8);\n                    backdrop-filter: blur(12px);\n                    -webkit-backdrop-filter: blur(12px);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    z-index: 3000;\n                    animation: fadeIn 0.2s ease-out;\n                }\n\n                .report-modal-card {\n                    background: linear-gradient(135deg, rgba(245, 245, 247, 0.98) 0%, rgba(235, 235, 237, 0.98) 100%);\n                    border-radius: 28px;\n                    padding: 32px 24px;\n                    width: 90%;\n                    max-width: 420px;\n                    text-align: center;\n                    box-shadow: \n                        0 24px 60px rgba(0, 0, 0, 0.4),\n                        0 0 0 1px rgba(0, 0, 0, 0.05);\n                    color: #1d1d1f;\n                    animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n                    position: relative;\n                }\n\n                .report-icon-header {\n                    width: 72px;\n                    height: 72px;\n                    margin: 0 auto 20px;\n                    background: rgba(255, 59, 48, 0.1);\n                    border-radius: 50%;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    border: 2px solid rgba(255, 59, 48, 0.2);\n                }\n\n                .report-icon-header svg {\n                    color: #ff3b30;\n                    filter: drop-shadow(0 2px 8px rgba(255, 59, 48, 0.2));\n                }\n\n                .report-modal-card h3 {\n                    margin: 0 0 8px 0;\n                    font-size: 1.5rem;\n                    font-weight: 700;\n                    color: #1d1d1f;\n                    letter-spacing: -0.02em;\n                }\n\n                .report-modal-card p {\n                    color: #6e6e73;\n                    margin-bottom: 24px;\n                    font-size: 0.95rem;\n                    font-weight: 400;\n                    line-height: 1.4;\n                }\n\n                .report-reasons {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 10px;\n                    margin-bottom: 20px;\n                }\n\n                .report-reasons button {\n                    background: white;\n                    border: 1px solid rgba(0, 0, 0, 0.08);\n                    color: #ff3b30;\n                    padding: 16px 20px;\n                    border-radius: 14px;\n                    font-size: 1rem;\n                    text-align: left;\n                    cursor: pointer;\n                    transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);\n                    display: flex;\n                    align-items: center;\n                    gap: 12px;\n                    font-weight: 600;\n                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);\n                }\n\n                .report-emoji {\n                    font-size: 1.3rem;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    min-width: 24px;\n                }\n\n                .report-reasons button:hover {\n                    background: rgba(255, 59, 48, 0.08);\n                    border-color: rgba(255, 59, 48, 0.3);\n                    transform: translateY(-2px);\n                    box-shadow: 0 4px 12px rgba(255, 59, 48, 0.15);\n                }\n\n                .report-reasons button:active {\n                    transform: translateY(0) scale(0.98);\n                }\n\n                .cancel-report-btn {\n                    width: 100%;\n                    padding: 14px;\n                    background: rgba(0, 0, 0, 0.05);\n                    border: none;\n                    border-radius: 14px;\n                    color: #6e6e73;\n                    font-weight: 600;\n                    cursor: pointer;\n                    transition: all 0.2s;\n                    font-size: 1rem;\n                }\n\n                .cancel-report-btn:hover {\n                    background: rgba(0, 0, 0, 0.08);\n                    color: #1d1d1f;\n                }\n\n                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n                @keyframes scaleIn { \n                    from { transform: scale(0.95) translateY(10px); opacity: 0; } \n                    to { transform: scale(1) translateY(0); opacity: 1; } \n                }\n            `}</style>\n\n            {/* Thought Input Overlay */}\n            {showThoughtInput && (\n                <div className=\"thought-input-overlay\" onClick={() => setShowThoughtInput(false)}>\n                    <div className=\"thought-card\" onClick={e => e.stopPropagation()}>\n                        <h3>ğŸ’­ Set a Status</h3>\n                        <form onSubmit={handlePostThought}>\n                            <input\n                                type=\"text\"\n                                placeholder=\"What's on your mind? (e.g. Coffee?)\"\n                                value={myThought}\n                                onChange={e => setMyThought(e.target.value)}\n                                maxLength={30}\n                                autoFocus\n                            />\n                            <div className=\"thought-actions\">\n                                <button type=\"button\" onClick={() => setShowThoughtInput(false)}>Cancel</button>\n                                {currentUser?.thought && (\n                                    <button\n                                        type=\"button\"\n                                        onClick={handleDeleteThought}\n                                        style={{\n                                            background: 'rgba(255, 59, 48, 0.1)',\n                                            color: '#ff3b30',\n                                            border: '1px solid rgba(255, 59, 48, 0.2)',\n                                            padding: '8px 12px',\n                                            fontSize: '1.2rem',\n                                            display: 'flex', alignItems: 'center', justifyContent: 'center'\n                                        }}\n                                        title=\"Delete Thought\"\n                                    >\n                                        ğŸ—‘ï¸\n                                    </button>\n                                )}\n                                <button type=\"submit\" className=\"primary\">Post</button>\n                            </div>\n                        </form>\n                        <p className=\"hint\">Disappears in 3 hours</p>\n                    </div>\n                </div>\n            )}\n\n\n            <div className=\"map-ui-overlay\">\n                <div className=\"stats-card\">\n                    <span>All View</span>\n                    <div className=\"stats-divider\"></div>\n                    <strong>{filteredUsers.length} Visible</strong>\n                </div>\n            </div>\n\n            <style>{`\n                .update-nudge {\n                    position: absolute;\n                    top: 100px; /* Below Top Nav which might be hidden on map, or just safe top area */\n                    /* Actually MapHome usually has no top nav, so maybe top: 20px */\n                    top: max(20px, calc(10px + env(safe-area-inset-top))); /* Notch support */\n                    left: 50%;\n                    transform: translateX(-50%);\n                    background: rgba(255, 69, 58, 0.9);\n                    backdrop-filter: blur(10px);\n                    color: white;\n                    padding: 10px 20px;\n                    border-radius: 30px;\n                    font-weight: 600;\n                    box-shadow: 0 4px 15px rgba(255, 69, 58, 0.3);\n                    z-index: 2000;\n                    cursor: pointer;\n                    animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);\n                    display: flex;\n                    align-items: center;\n                    gap: 8px;\n                    font-size: 0.9rem;\n                    border: 1px solid rgba(255,255,255,0.2);\n                }\n                .update-nudge:hover {\n                    background: rgba(255, 69, 58, 1);\n                    transform: translateX(-50%) scale(1.05);\n                }\n                @keyframes bounceIn {\n                    from { transform: translateX(-50%) translateY(-20px); opacity: 0; }\n                    to { transform: translateX(-50%) translateY(0); opacity: 1; }\n                }\n\n                /* Onboarding Styles - Premium Glassmorphism */\n                .onboarding-overlay {\n                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n                    background: rgba(0, 0, 0, 0.6);\n                    backdrop-filter: blur(20px);\n                    -webkit-backdrop-filter: blur(20px);\n                    z-index: 999999;\n                    display: flex; align-items: center; justify-content: center;\n                    animation: fadeIn 0.4s ease-out;\n                }\n                \n                .onboarding-card {\n                    background: rgba(20, 20, 25, 0.95);\n                    backdrop-filter: blur(40px);\n                    -webkit-backdrop-filter: blur(40px);\n                    padding: 30px 24px; \n                    border-radius: 24px;\n                    width: 90%; max-width: 380px; \n                    color: white;\n                    border: 1px solid rgba(255, 255, 255, 0.08);\n                    box-shadow: \n                        0 20px 60px rgba(0, 0, 0, 0.6),\n                        0 0 0 1px rgba(255, 255, 255, 0.05) inset;\n                    max-height: 90vh; overflow-y: auto;\n                    animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);\n                    position: relative;\n                }\n                \n                /* Scrollbar polish */\n                .onboarding-card::-webkit-scrollbar { width: 4px; }\n                .onboarding-card::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }\n\n                .onboarding-card h2 { \n                    margin-top: 0; \n                    margin-bottom: 4px;\n                    font-size: 1.5rem;\n                    background: linear-gradient(135deg, #00C6FF 0%, #0072FF 100%); \n                    -webkit-background-clip: text; \n                    -webkit-text-fill-color: transparent; \n                    text-align: center;\n                    letter-spacing: -0.5px;\n                }\n                \n                .onboarding-subtitle {\n                    text-align: center;\n                    color: rgba(255,255,255,0.6);\n                    font-size: 0.85rem;\n                    margin-bottom: 20px;\n                }\n\n                .ob-section { margin-bottom: 16px; }\n                .ob-section label { \n                    display: block; \n                    margin-bottom: 6px; \n                    font-weight: 600; \n                    color: rgba(255,255,255,0.9);\n                    font-size: 0.85rem;\n                    letter-spacing: 0.3px;\n                }\n\n                .ob-input {\n                    width: 100%; padding: 12px 14px;\n                    background: rgba(255, 255, 255, 0.05);\n                    border: 1px solid rgba(255, 255, 255, 0.1);\n                    border-radius: 12px; \n                    color: white;\n                    font-size: 0.9rem; \n                    outline: none;\n                    transition: all 0.2s ease;\n                }\n                .ob-input:focus { \n                    background: rgba(255, 255, 255, 0.1);\n                    border-color: #00C6FF; \n                    box-shadow: 0 0 0 4px rgba(0, 198, 255, 0.15);\n                }\n\n                .chip-group { display: flex; flex-wrap: wrap; gap: 8px; }\n                .chip {\n                    background: rgba(255, 255, 255, 0.05); \n                    border: 1px solid rgba(255, 255, 255, 0.1);\n                    color: rgba(255,255,255,0.7); \n                    padding: 8px 14px; \n                    border-radius: 14px; \n                    cursor: pointer;\n                    font-size: 0.8rem;\n                    font-weight: 500;\n                    transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);\n                }\n                .chip:hover {\n                    background: rgba(255, 255, 255, 0.1);\n                    transform: translateY(-1px);\n                    color: white;\n                }\n                .chip.selected { \n                    background: linear-gradient(135deg, #00C6FF 0%, #0072FF 100%); \n                    color: white; \n                    border-color: transparent; \n                    font-weight: 600; \n                    box-shadow: 0 4px 12px rgba(0, 114, 255, 0.3);\n                    transform: translateY(-1px);\n                }\n                \n                .complete-btn {\n                    width: 100%; padding: 14px; \n                    background: linear-gradient(135deg, #00C6FF 0%, #0072FF 100%);\n                    color: white; \n                    font-weight: 700; \n                    font-size: 1rem; \n                    border: none; \n                    border-radius: 14px; \n                    cursor: pointer;\n                    margin-top: 8px;\n                    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);\n                    box-shadow: 0 8px 20px rgba(0, 114, 255, 0.3);\n                }\n                .complete-btn:hover {\n                    transform: translateY(-2px) scale(1.01);\n                    box-shadow: 0 12px 25px rgba(0, 114, 255, 0.5);\n                }\n                .complete-btn:active { transform: scale(0.98); }\n\n                .avatar-preview-box {\n                    text-align: center; \n                    padding: 16px; \n                    background: rgba(255, 255, 255, 0.03); \n                    border-radius: 18px;\n                    border: 1px solid rgba(255, 255, 255, 0.08);\n                    margin-top: 4px;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    flex-direction: column;\n                }\n                .avatar-preview-box img {\n                    width: 80px; height: 80px; \n                    border-radius: 50%; \n                    border: 3px solid rgba(255, 255, 255, 0.15); \n                    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);\n                    object-fit: cover;\n                    transition: all 0.3s ease;\n                }\n                .avatar-preview-box img:hover {\n                    transform: scale(1.05);\n                    border-color: #00C6FF;\n                }\n                .avatar-hint {\n                    margin-top: 10px; \n                    font-size: 0.8rem; \n                    color: rgba(255, 255, 255, 0.5);\n                    line-height: 1.4;\n                    max-width: 90%;\n                }\n\n                .map-container {\n                    height: 100vh;\n                    width: 100%;\n                    position: relative;\n                    background: var(--bg-color);\n                }\n                .leaflet-marker-icon {\n                    transition: transform 1s linear;\n                }\n                .map-ui-overlay {\n                    position: absolute;\n                    bottom: 80px;\n                    left: 0; right: 0;\n                    display: flex; justify-content: center;\n                    z-index: 999;\n                    pointer-events: none; \n                }\n                \n                /* INJECTED AVATAR STYLES (Backup if App.css fails) */\n                .avatar-group {\n                    position: relative;\n                    width: 50px; height: 50px;\n                    overflow: visible;\n                }\n                .avatar-marker {\n                    width: 100%; height: 100%;\n                    background-size: cover; background-position: center;\n                    border-radius: 50%;\n                    border: 3px solid #FFFFFF;\n                    box-shadow: 0 4px 10px rgba(0,0,0,0.3);\n                    background-color: #333;\n                }\n                .thought-bubble {\n                    position: absolute;\n                    bottom: 125%; left: 50%;\n                    transform: translateX(-50%);\n                    background: white; color: black;\n                    padding: 4px 8px; border-radius: 12px;\n                    font-size: 0.75rem; white-space: nowrap;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    border: 2px solid #4285F4;\n                    z-index: 9999;\n                    text-align: center;\n                }\n                \n                /* SMOOTH MARKER ANIMATIONS */\n                /* Re-enabled for real-time smooth location gliding */\n                .leaflet-marker-icon {\n                    transition: transform 0.5s ease-out;\n                    opacity: 1; \n                }\n                \n                /* Class specific for avatars */\n                .leaflet-marker-icon.custom-avatar-icon {\n                    will-change: transform, opacity;\n                }\n\n                .stats-card {\n                    pointer-events: auto;\n                    background: white;\n                    padding: 8px 20px;\n                    border-radius: 50px;\n                    box-shadow: 0 4px 15px rgba(0,0,0,0.15);\n                    color: #333;\n                    display: flex; align-items: center; gap: 12px;\n                    font-size: 0.95rem;\n                    font-weight: 500;\n                    z-index: 2000;\n                }\n                \n                /* Dark Mode Stats Card - Keep it white with black text */\n                /* Increased specificity to override global index.css rules */\n                html[data-theme=\"dark\"] #root .stats-card {\n                    background: white !important;\n                    color: #000000 !important;\n                }\n                html[data-theme=\"dark\"] #root .stats-card span,\n                html[data-theme=\"dark\"] #root .stats-card strong,\n                html[data-theme=\"dark\"] #root .stats-card div {\n                    color: #000000 !important;\n                }\n                \n                /* System theme block removed */\n                .stats-divider { width: 1px; height: 18px; background: #bbb; }\n                /* Controls and Thought Input Styles kept minimal here, mostly moved to App.css or generic */\n                /* Dark Map Tiles Filter */\n                .dark-map-tiles {\n                    filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);\n                    -webkit-filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);\n                }\n\n                .thought-input-overlay {\n                    position: fixed; inset: 0; background: rgba(0,0,0,0.5);\n                    display: flex; align-items: center; justify-content: center; z-index: 3000;\n                    backdrop-filter: blur(2px);\n                }\n                .thought-card {\n                    background: white; padding: 20px; border-radius: 20px; width: 80%; max-width: 320px;\n                    display: flex; flex-direction: column; gap: 10px;\n                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);\n                }\n                .thought-card h3 { margin: 0; font-size: 1.1rem; color: #333; }\n                .thought-card input {\n                    width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; outline: none;\n                }\n                .thought-card input:focus { border-color: #4285F4; }\n                .thought-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 5px; }\n                .thought-actions button { padding: 8px 16px; border-radius: 8px; border:none; cursor: pointer; font-weight: 600; }\n                .thought-actions button.primary { background: #4285F4; color: white; }\n                .hint { font-size: 0.75rem; color: #888; margin: 0; text-align: center; }\n\n                /* Dark Mode for Thought Card */\n                html[data-theme=\"dark\"] .thought-card {\n                    background: #1e1e24 !important;\n                    border: 1px solid rgba(255, 255, 255, 0.1);\n                }\n                html[data-theme=\"dark\"] .thought-card h3 {\n                    color: white;\n                }\n                html[data-theme=\"dark\"] .thought-card input {\n                    background: rgba(0, 0, 0, 0.3);\n                    color: white;\n                    border-color: rgba(255, 255, 255, 0.2);\n                }\n                html[data-theme=\"dark\"] .thought-card input:focus {\n                    border-color: #4285F4;\n                }\n                html[data-theme=\"dark\"] .thought-actions button {\n                    background: rgba(255, 255, 255, 0.1);\n                    color: white;\n                }\n                html[data-theme=\"dark\"] .thought-actions button.primary {\n                    background: #4285F4;\n                }\n\n                @media (prefers-color-scheme: dark) {\n                    html[data-theme=\"system\"] .thought-card {\n                        background: #1e1e24 !important;\n                        border: 1px solid rgba(255, 255, 255, 0.1);\n                    }\n                    html[data-theme=\"system\"] .thought-card h3 {\n                        color: white;\n                    }\n                    html[data-theme=\"system\"] .thought-card input {\n                        background: rgba(0, 0, 0, 0.3);\n                        color: white;\n                        border-color: rgba(255, 255, 255, 0.2);\n                    }\n                    html[data-theme=\"system\"] .thought-actions button {\n                        background: rgba(255, 255, 255, 0.1);\n                        color: white;\n                    }\n                    html[data-theme=\"system\"] .thought-actions button.primary {\n                        background: #4285F4;\n                    }\n                }\n\n\n\n                /* Report Modal Styles */\n                .report-modal-overlay {\n                    position: fixed; inset: 0; background: rgba(0,0,0,0.7);\n                    display: flex; align-items: center; justify-content: center; z-index: 5000;\n                    backdrop-filter: blur(3px);\n                }\n                .report-modal-card {\n                    background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 360px;\n                    box-shadow: 0 10px 40px rgba(0,0,0,0.4);\n                }\n                .report-modal-card h3 { margin: 0 0 10px 0; font-size: 1.2rem; color: #333; }\n                .report-modal-card p { margin: 0 0 15px 0; font-size: 0.9rem; color: #666; }\n                .report-reasons {\n                    display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;\n                }\n                .report-reasons button {\n                    padding: 12px 15px; background: rgba(255, 69, 58, 0.1);\n                    border: 1px solid rgba(255, 69, 58, 0.3); border-radius: 10px;\n                    color: #ff453a; cursor: pointer; font-size: 0.9rem; font-weight: 600;\n                    text-align: left; transition: all 0.2s;\n                }\n                .report-reasons button:hover {\n                    background: rgba(255, 69, 58, 0.2); border-color: #ff453a;\n                    transform: translateX(5px);\n                }\n                .cancel-report-btn {\n                    width: 100%; padding: 12px; background: rgba(0,0,0,0.05);\n                    border: 1px solid rgba(0,0,0,0.1); border-radius: 10px;\n                    color: #666; cursor: pointer; font-size: 0.9rem; font-weight: 600;\n                }\n                .cancel-report-btn:hover { background: rgba(0,0,0,0.1); }\n                \n                /* Avatar styles moved to App.css for consistency */\n            `}</style>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]}]
